

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>standard_sequence.classy_sequence &mdash; mmwave-labscript  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            mmwave-labscript
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mmwave-labscript</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">standard_sequence.classy_sequence</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for standard_sequence.classy_sequence</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Feb 16 11:33:13 2023</span>

<span class="sd">@author: sslab</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ClassVar</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;X:\userlib\labscriptlib&quot;</span>

<span class="k">if</span> <span class="n">root_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">labscriptlib.shot_globals</span> <span class="kn">import</span> <span class="n">shot_globals</span>
<span class="c1">#from shot_globals import shot_globals</span>
<span class="kn">from</span> <span class="nn">spectrum_manager_fifo</span> <span class="kn">import</span> <span class="n">spectrum_manager_fifo</span>
<span class="kn">from</span> <span class="nn">spectrum_manager</span> <span class="kn">import</span> <span class="n">spectrum_manager</span>
<span class="kn">from</span> <span class="nn">calibration</span> <span class="kn">import</span> <span class="n">ta_freq_calib</span><span class="p">,</span> <span class="n">repump_freq_calib</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">,</span> <span class="n">biasz_calib</span>
<span class="kn">from</span> <span class="nn">connection_table</span> <span class="kn">import</span> <span class="n">devices</span>
<span class="kn">import</span> <span class="nn">labscript</span>

<span class="n">spcm_sequence_mode</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_sequence_mode</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

<span class="c1"># fixed parameters in the script</span>
<span class="n">CONST_COIL_OFF_TIME</span> <span class="o">=</span> <span class="mf">1.4e-3</span>  <span class="c1"># minimum time for the MOT coil to be off</span>
<span class="n">CONST_TA_VCO_RAMP_TIME</span> <span class="o">=</span> <span class="mf">1.2e-4</span>
<span class="n">CONST_MIN_SHUTTER_OFF_TIME</span> <span class="o">=</span> <span class="mf">6.28e-3</span>  <span class="c1"># minimum time for shutter to be off and on again</span>
<span class="n">CONST_MIN_SHUTTER_ON_TIME</span> <span class="o">=</span> <span class="mf">3.6e-3</span>  <span class="c1"># minimum time for shutter to be on</span>
<span class="n">CONST_SHUTTER_TURN_ON_TIME</span>  <span class="o">=</span> <span class="mf">2e-3</span> <span class="c1"># for shutter take from start to close to fully close</span>
<span class="n">CONST_SHUTTER_TURN_OFF_TIME</span> <span class="o">=</span> <span class="mf">2e-3</span> <span class="c1"># for shutter take from start to open to fully open</span>


<span class="c1"># lasers_852 =  D2Lasers()</span>
<span class="c1"># lasers_852.pulse_imaging(t=300e-6, duration=100e-6)</span>
<span class="c1"># lasers_852.pulse_ta(t=450e-6, duration=100e-6, hold_shutter_open = True)</span>
<span class="c1"># pulser_ta(t=600e-6, duration=100e-6)</span>


<span class="c1"># MOTconfig = {shutter1: True, shutter2: False, shutter3: True}</span>
<span class="c1"># imagconfig = {shutter1: False, shutter2: True, }</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">auto</span>


<div class="viewcode-block" id="ShutterConfig">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.ShutterConfig">[docs]</a>
<span class="k">class</span> <span class="nc">ShutterConfig</span><span class="p">(</span><span class="n">Flag</span><span class="p">):</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">TA</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">REPUMP</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">MOT_XY</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">MOT_Z</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">IMG_XY</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">IMG_Z</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">OPTICAL_PUMPING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

    <span class="n">UPSTREAM</span> <span class="o">=</span> <span class="n">TA</span> <span class="o">|</span> <span class="n">REPUMP</span>
    <span class="n">MOT_FULL</span> <span class="o">=</span> <span class="n">UPSTREAM</span> <span class="o">|</span> <span class="n">MOT_XY</span> <span class="o">|</span> <span class="n">MOT_Z</span>
    <span class="n">MOT_TA</span> <span class="o">=</span> <span class="n">TA</span> <span class="o">|</span> <span class="n">MOT_XY</span> <span class="o">|</span> <span class="n">MOT_Z</span>
    <span class="n">MOT_REPUMP</span> <span class="o">=</span> <span class="n">REPUMP</span> <span class="o">|</span> <span class="n">MOT_XY</span> <span class="o">|</span> <span class="n">MOT_Z</span>

    <span class="n">IMG_FULL</span> <span class="o">=</span> <span class="n">UPSTREAM</span> <span class="o">|</span> <span class="n">IMG_XY</span> <span class="o">|</span> <span class="n">IMG_Z</span>
    <span class="n">IMG_TA</span> <span class="o">=</span> <span class="n">TA</span> <span class="o">|</span> <span class="n">IMG_XY</span> <span class="o">|</span> <span class="n">IMG_Z</span>
    <span class="n">IMG_REPUMP</span> <span class="o">=</span> <span class="n">REPUMP</span> <span class="o">|</span> <span class="n">IMG_XY</span> <span class="o">|</span> <span class="n">IMG_Z</span>

    <span class="n">OPTICAL_PUMPING_FULL</span> <span class="o">=</span> <span class="n">UPSTREAM</span> <span class="o">|</span> <span class="n">OPTICAL_PUMPING</span>
    <span class="n">OPTICAL_PUMPING_TA</span> <span class="o">=</span> <span class="n">TA</span> <span class="o">|</span> <span class="n">OPTICAL_PUMPING</span>
    <span class="n">OPTICAL_PUMPING_REPUMP</span> <span class="o">=</span> <span class="n">REPUMP</span> <span class="o">|</span> <span class="n">OPTICAL_PUMPING</span>

    <span class="n">shutter_dict</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">ShutterConfig</span><span class="p">,</span> <span class="n">labscript</span><span class="o">.</span><span class="n">Shutter</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">TA</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="p">,</span>
        <span class="n">REPUMP</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="p">,</span>
        <span class="n">MOT_XY</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="p">,</span>
        <span class="n">MOT_Z</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="p">,</span>
        <span class="n">IMG_XY</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="p">,</span>
        <span class="n">IMG_Z</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="p">,</span>
        <span class="n">OPTICAL_PUMPING</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="p">,</span>
    <span class="p">}</span>


    <span class="c1"># TODO: replace globals with arguments</span>
<div class="viewcode-block" id="ShutterConfig.select_imgaging_shutters">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.ShutterConfig.select_imgaging_shutters">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">select_imgaging_shutters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">do_repump</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ShutterConfig</span><span class="p">:</span>
        <span class="n">repump_config</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">REPUMP</span> <span class="k">if</span> <span class="n">do_repump</span> <span class="k">else</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
        <span class="n">label</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">imaging_label</span>

        <span class="c1"># TODO: change handling of labels to make full default and raise error when not one of the options</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
                <span class="n">shutter_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MOT_Z</span> <span class="o">|</span> <span class="n">repump_config</span>
            <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;xy&quot;</span><span class="p">:</span>
                <span class="n">shutter_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MOT_XY</span> <span class="o">|</span> <span class="n">repump_config</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutter_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MOT_FULL</span> <span class="o">|</span> <span class="n">repump_config</span>

        <span class="c1">#If you&#39;re trying to do in-situ imaging, you want to image faster than switch shutters allows for, so you can&#39;t do imaging beam imaging</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_in_situ_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
                <span class="n">shutter_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">IMG_Z</span> <span class="o">|</span> <span class="n">repump_config</span>
            <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;xy&quot;</span><span class="p">:</span>
                <span class="n">shutter_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">IMG_XY</span> <span class="o">|</span> <span class="n">repump_config</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutter_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">IMG_FULL</span> <span class="o">|</span> <span class="n">repump_config</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutter_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NONE</span>

        <span class="k">return</span> <span class="n">shutter_config</span></div>
</div>



<span class="c1"># Hardware control classes</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="D2Lasers">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers">[docs]</a>
<span class="k">class</span> <span class="nc">D2Lasers</span><span class="p">:</span>
    <span class="n">shutter_config</span><span class="p">:</span> <span class="n">ShutterConfig</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Tune to MOT frequency, full power</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_freq</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repump_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="c1"># shot_globals.mot_repump_detuning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_power</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repump_power</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span> <span class="o">=</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">NONE</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_freq_calib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ta_freq</span><span class="p">))</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">repump_freq_calib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repump_freq</span><span class="p">))</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ta_power</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repump_power</span><span class="p">)</span>

        <span class="c1"># TODO: Initialize shutters??</span>


    <span class="c1">#Move freq_calib to a function within here? Probably not needed.</span>
<div class="viewcode-block" id="D2Lasers.ramp_ta_freq">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.ramp_ta_freq">[docs]</a>
    <span class="k">def</span> <span class="nf">ramp_ta_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">final</span><span class="p">):</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ta_freq</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">final</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_freq</span> <span class="o">=</span> <span class="n">final</span></div>


<div class="viewcode-block" id="D2Lasers.ramp_repump_freq">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.ramp_repump_freq">[docs]</a>
    <span class="k">def</span> <span class="nf">ramp_repump_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">final</span><span class="p">):</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repump_freq</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">final</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repump_freq</span> <span class="o">=</span> <span class="n">final</span></div>


    <span class="k">def</span> <span class="nf">ta_aom_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn off the ta beam using aom &quot;&quot;&quot;</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># digital off</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># analog off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_power</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="D2Lasers.ta_aom_on">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.ta_aom_on">[docs]</a>
    <span class="k">def</span> <span class="nf">ta_aom_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">const</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn on the ta beam using aom &quot;&quot;&quot;</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># digital on</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>  <span class="c1"># analog to const</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_power</span> <span class="o">=</span> <span class="n">const</span></div>


<div class="viewcode-block" id="D2Lasers.ta_aom_off">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.ta_aom_off">[docs]</a>
    <span class="k">def</span> <span class="nf">ta_aom_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn off the repump beam using aom &quot;&quot;&quot;</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># digital off</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># analog off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_power</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="D2Lasers.repump_aom_off">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.repump_aom_off">[docs]</a>
    <span class="k">def</span> <span class="nf">repump_aom_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn off the repump beam using aom &quot;&quot;&quot;</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># digital off</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># analog off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repump_power</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="D2Lasers.repump_aom_on">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.repump_aom_on">[docs]</a>
    <span class="k">def</span> <span class="nf">repump_aom_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">const</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn on the repump beam using aom &quot;&quot;&quot;</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># digital on</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>  <span class="c1"># analog to const</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repump_power</span> <span class="o">=</span> <span class="n">const</span></div>



<div class="viewcode-block" id="D2Lasers.ramp_ta_aom">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.ramp_ta_aom">[docs]</a>
    <span class="k">def</span> <span class="nf">ramp_ta_aom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">final_power</span><span class="p">):</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ta_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">final_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="D2Lasers.ramp_repump_aom">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.ramp_repump_aom">[docs]</a>
    <span class="k">def</span> <span class="nf">ramp_repump_aom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">final_power</span><span class="p">):</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repump_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">final_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="D2Lasers.update_shutters">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.update_shutters">[docs]</a>
    <span class="k">def</span> <span class="nf">update_shutters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">new_shutter_config</span><span class="p">:</span> <span class="n">ShutterConfig</span><span class="p">,</span> <span class="n">early_close</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">changed_shutters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span> <span class="o">^</span> <span class="n">new_shutter_config</span>

        <span class="n">shutters_to_open</span> <span class="o">=</span> <span class="n">changed_shutters</span> <span class="o">&amp;</span> <span class="n">new_shutter_config</span>
        <span class="n">shutters_to_close</span> <span class="o">=</span> <span class="n">changed_shutters</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">shutters_to_open</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">shutter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span><span class="o">.</span><span class="n">shutter_dict</span><span class="p">[</span><span class="n">shutters_to_open</span><span class="p">]:</span>
            <span class="n">shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">shutter</span> <span class="ow">in</span> <span class="n">shutters_to_close</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">early_close</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span><span class="o">.</span><span class="n">shutter_dict</span><span class="p">[</span><span class="n">shutter</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span><span class="o">.</span><span class="n">shutter_dict</span><span class="p">[</span><span class="n">shutter</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span> <span class="o">=</span> <span class="n">new_shutter_config</span></div>

        <span class="c1">#return t?</span>

<span class="c1"># NOTE: This version makes it so that the previous shutters are fully closed before opening the new shutters</span>
    <span class="c1"># def update_shutters(self, t, new_shutter_config: ShutterConfig):</span>
    <span class="c1">#     changed_shutters = self.shutter_config ^ new_shutter_config</span>

    <span class="c1">#     shutters_to_open = changed_shutters &amp; new_shutter_config</span>
    <span class="c1">#     shutters_to_close = changed_shutters &amp; self.shutter_config</span>

    <span class="c1">#     for shutter in shutters_to_close:</span>
    <span class="c1">#         self.shutter_config.shutter_dict[shutter].close(t)</span>

    <span class="c1">#     t += 2*CONST_SHUTTER_TURN_OFF_TIME</span>
    <span class="c1">#     for shutter in shutters_to_open:</span>
    <span class="c1">#         self.shutter_config.shutter_dict[shutter].open(t)</span>

    <span class="c1">#     self.shutter_config = new_shutter_config</span>
    <span class="c1">#     return t</span>

    <span class="c1"># NOTE: If the shutter configuration is changed from the previous pulse, this will cut the previous pulse short</span>
    <span class="c1"># with the AOM by CONST_SHUTTER_TURN_ON_TIME in order to switch the shutters, and start the next pulse exactly at the t specified.</span>
    <span class="c1"># NOTE: The above note should be taken in context with the one below.</span>
<div class="viewcode-block" id="D2Lasers.do_pulse">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.do_pulse">[docs]</a>
    <span class="k">def</span> <span class="nf">do_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">shutter_config</span><span class="p">,</span> <span class="n">ta_power</span><span class="p">,</span> <span class="n">repump_power</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">change_shutters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutter_config</span> <span class="o">!=</span> <span class="n">shutter_config</span>

        <span class="k">if</span> <span class="n">change_shutters</span><span class="p">:</span>
            <span class="c1"># NOTE:Adding this to t makes it so it doesn&#39;t cut the previous pulse short, but shifts the time of the next.</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shutter config changed, adding time to account for switching&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ta_aom_off</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repump_aom_off</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shutter_config</span><span class="p">,</span> <span class="n">early_close</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ta_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ta_aom_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_power</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ta_power</span> <span class="o">=</span> <span class="n">ta_power</span>
        <span class="k">if</span> <span class="n">repump_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repump_aom_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">repump_power</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repump_power</span> <span class="o">=</span> <span class="n">repump_power</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">dur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_aom_off</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repump_aom_off</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">dur</span> <span class="o">&lt;</span> <span class="n">CONST_MIN_SHUTTER_ON_TIME</span><span class="p">)</span> <span class="ow">and</span> <span class="n">change_shutters</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_MIN_SHUTTER_ON_TIME</span> <span class="o">-</span> <span class="n">dur</span>

        <span class="c1"># If doing close_all_shutters, have to make sure that we aren&#39;t opening any of the ones we just closed in the next pulse.</span>
        <span class="c1"># Otherwise they won&#39;t be able to open in time unless there&#39;s enough delay between pulses.</span>
        <span class="k">if</span> <span class="n">close_all_shutters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_shutters</span><span class="p">(</span><span class="n">ShutterConfig</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_SHUTTER_TURN_OFF_TIME</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ta_aom_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repump_aom_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="D2Lasers.reset_to_mot_freq">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.reset_to_mot_freq">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_to_mot_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
                              <span class="n">final</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
                          <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span>
        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="D2Lasers.reset_to_mot_on">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.D2Lasers.reset_to_mot_on">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_to_mot_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ta_aom_on</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repump_aom_on</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_shutters</span><span class="p">(</span><span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_FULL</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span>

        <span class="k">return</span> <span class="n">t</span></div>
</div>




<div class="viewcode-block" id="TweezerLaser">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerLaser">[docs]</a>
<span class="k">class</span> <span class="nc">TweezerLaser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Microwave">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.Microwave">[docs]</a>
<span class="k">class</span> <span class="nc">Microwave</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Shutoff microwaves?</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_dds_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="RydLasers">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.RydLasers">[docs]</a>
<span class="k">class</span> <span class="nc">RydLasers</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="UVLamps">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.UVLamps">[docs]</a>
<span class="k">class</span> <span class="nc">UVLamps</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Turn off UV lamps</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uv_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<div class="viewcode-block" id="UVLamps.uv_pulse">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.UVLamps.uv_pulse">[docs]</a>
    <span class="k">def</span> <span class="nf">uv_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flash the UV LED lamps for dur seconds&quot;&quot;&quot;</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uv_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">dur</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uv_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span></div>
</div>



<div class="viewcode-block" id="BField">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.BField">[docs]</a>
<span class="k">class</span> <span class="nc">BField</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_coil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on_current</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="mi">6</span>

        <span class="c1">#Same question as for Dline_lasers, should we automatically initialize the hardware here or in a separate function we can call?</span>

        <span class="c1">#this isn&#39;t quite right, we should have an inverse of bias_i_calib function that gives B depending on mot_i_coil_voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_field</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on_current</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="BField.ramp_B_field">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.BField.ramp_B_field">[docs]</a>
    <span class="k">def</span> <span class="nf">ramp_B_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">B_field_vector</span><span class="p">):</span>
        <span class="c1">#B_field_vector should be a tuple of the form (x,y,z)</span>
        <span class="c1"># Need to start the ramp earlier if the voltage changes sign</span>
        <span class="n">t_x_coil</span><span class="p">,</span> <span class="n">t_y_coil</span><span class="p">,</span> <span class="n">t_z_coil</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span> <span class="o">*</span> <span class="n">biasx_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>
                                        <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span> <span class="o">*</span> <span class="n">biasy_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>
                                        <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span> <span class="o">*</span> <span class="n">biasz_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">ramp_dur</span> <span class="o">=</span> <span class="mf">100e-6</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t_x_coil</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t_y_coil</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasy_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t_z_coil</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">B_field</span> <span class="o">=</span> <span class="n">B_field_vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span> <span class="o">=</span> <span class="n">biasx_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span> <span class="o">=</span> <span class="n">biasy_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span> <span class="o">=</span> <span class="n">biasz_calib</span><span class="p">(</span><span class="n">B_field_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">ramp_dur</span>
        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="BField.ramp_B_field_voltage">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.BField.ramp_B_field_voltage">[docs]</a>
    <span class="k">def</span> <span class="nf">ramp_B_field_voltage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">voltage_vector</span><span class="p">):</span>
        <span class="c1">#B_field_vector should be a tuple of the form (x,y,z)</span>
        <span class="c1"># Need to start the ramp earlier if the voltage changes sign</span>
        <span class="n">t_x_coil</span><span class="p">,</span> <span class="n">t_y_coil</span><span class="p">,</span> <span class="n">t_z_coil</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span> <span class="o">*</span> <span class="n">voltage_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>
                                        <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span> <span class="o">*</span> <span class="n">voltage_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>
                                        <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span> <span class="o">*</span> <span class="n">voltage_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">ramp_dur</span> <span class="o">=</span> <span class="mf">100e-6</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t_x_coil</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">voltage_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t_y_coil</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">voltage_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t_z_coil</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">voltage_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># TODO: add the inverse function of bias_i_calib</span>
        <span class="c1"># self.B_field = B_field_vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_x_voltage</span> <span class="o">=</span> <span class="n">voltage_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_y_voltage</span> <span class="o">=</span> <span class="n">voltage_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_z_voltage</span> <span class="o">=</span> <span class="n">voltage_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">ramp_dur</span>
        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="BField.switch_mot_coils">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.BField.switch_mot_coils">[docs]</a>
    <span class="k">def</span> <span class="nf">switch_mot_coils</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">ramp_dur</span> <span class="o">=</span> <span class="mf">100e-6</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on_current</span><span class="p">,</span>
                <span class="n">final</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">ramp_dur</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on_current</span><span class="p">,</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mot_coils_on</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">ramp_dur</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_COIL_OFF_TIME</span>
        <span class="k">return</span> <span class="n">t</span></div>
</div>


<div class="viewcode-block" id="Camera">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.Camera">[docs]</a>
<span class="k">class</span> <span class="nc">Camera</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Camera.set_type">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.Camera.set_type">[docs]</a>
    <span class="k">def</span> <span class="nf">set_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="c1"># type = &quot;MOT_manta&quot; or &quot;tweezer_manta&quot; or &quot;kinetix&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span></div>


<div class="viewcode-block" id="Camera.expose">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.Camera.expose">[docs]</a>
    <span class="k">def</span> <span class="nf">expose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">,</span> <span class="n">trigger_local_manta</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">trigger_local_manta</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_camera_trigger</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_camera_trigger</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">exposure_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MOT_manta&quot;</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_mot</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
                <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
                <span class="n">exposure_time</span> <span class="o">=</span> <span class="n">exposure_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;tweezer_manta&quot;</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_tweezer</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
                <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
                <span class="n">exposure_time</span><span class="o">=</span><span class="n">exposure_time</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;kinetix&quot;</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">kinetix</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
                <span class="s1">&#39;Kinetix&#39;</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
                <span class="n">exposure_time</span><span class="o">=</span><span class="n">exposure_time</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>


<div class="viewcode-block" id="EField">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.EField">[docs]</a>
<span class="k">class</span> <span class="nc">EField</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">pass</span></div>


<span class="c1">#Sequence Classes</span>
<span class="c1">#-------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="MOTSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence">[docs]</a>
<span class="k">class</span> <span class="nc">MOTSequence</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Standard initialization for hardware objects puts everything in</span>
        <span class="c1"># correct state/tuning to start loading the MOT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span> <span class="o">=</span> <span class="n">D2Lasers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span> <span class="o">=</span> <span class="n">BField</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span> <span class="o">=</span> <span class="n">Microwave</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UVLamps_obj</span> <span class="o">=</span> <span class="n">UVLamps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<div class="viewcode-block" id="MOTSequence.do_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_mot">[docs]</a>
    <span class="k">def</span> <span class="nf">do_mot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_uv</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UVLamps_obj</span><span class="o">.</span><span class="n">uv_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
            <span class="c1"># longer duration than 1e-2 will lead to the overall MOT atom</span>
            <span class="c1"># number decay during the cycle</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_FULL</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span>
                                        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span><span class="p">,</span> <span class="n">close_all_shutters</span> <span class="o">=</span> <span class="n">close_all_shutters</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.reset_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.reset_mot">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_mot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1">#B fields</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">mot_bias_voltages</span> <span class="o">=</span> <span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_B_field_voltage</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_bias_voltages</span><span class="p">)</span>

        <span class="c1"># Reset laser frequency and configuration</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_freq</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.image_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.image_mot">[docs]</a>
    <span class="k">def</span> <span class="nf">image_mot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Move to on resonance, make sure AOM is off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">ta_freq_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span>

        <span class="c1"># Make sure coils are off</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="s2">&quot;MOT_manta&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_exposure_time</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;before doing a MOT pulse for image t = &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_exposure_time</span><span class="p">,</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_FULL</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span>
                                        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span><span class="p">,</span> <span class="n">close_all_shutters</span> <span class="o">=</span> <span class="n">close_all_shutters</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.do_mot_in_situ_sequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_mot_in_situ_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">do_mot_in_situ_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running do_mot_in_situ_check&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MOT coils = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">)</span>
        <span class="c1"># MOT loading time 500 ms</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Shutter does not need to be held open</span>

        <span class="c1"># Wait until the MOT disappear for background image</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Reset laser frequency so lasers do not jump frequency and come unlocked</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_freq</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


    <span class="c1"># TODO: Needs more experimental debugging. When should the shutter close? What timescales should we expect the MOT to disperse in?</span>
<div class="viewcode-block" id="MOTSequence.do_mot_tof_sequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_mot_tof_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">do_mot_tof_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running do_mot_in_situ_check&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MOT coils = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">)</span>
        <span class="c1"># MOT loading time 500 ms</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>

        <span class="c1"># assert shot_globals.mot_tof_imaging_delay &gt; CONST_MIN_SHUTTER_OFF_TIME, &quot;time of flight too short for shutter&quot;</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_tof_imaging_delay</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Shutter does not need to be held open</span>

        <span class="c1"># Wait until the MOT disappear for background image</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Reset laser frequency so lasers do not jump frequency and come unlocked</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_freq</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


    <span class="c1"># Molasses sequences</span>
<div class="viewcode-block" id="MOTSequence.ramp_to_molasses">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.ramp_to_molasses">[docs]</a>
    <span class="k">def</span> <span class="nf">ramp_to_molasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_bm_detuning</span><span class="p">,</span> <span class="n">repump_bm_detuning</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">ta_bm_detuning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">repump_bm_detuning</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_B_field</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Molasses stage&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ta_last_detuning = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ta_freq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;repump_last_detuning = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ta_freq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.do_molasses">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_molasses">[docs]</a>
    <span class="k">def</span> <span class="nf">do_molasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_img_beam</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_mot_beam</span><span class="p">),</span> <span class="s2">&quot;either do_molasses_img_beam or do_molasses_mot_beam has to be on&quot;</span>
        <span class="c1">#TODO: what does this assert statement mean?</span>
        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bright molasses detuning = 0, did you forget to correct for the new case?&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;molasses detuning is </span><span class="si">{</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#Should we do this in-sequence?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ramp_to_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_detuning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_mot_beam</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_FULL</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_power</span><span class="p">,</span>
                                <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_power</span><span class="p">,</span> <span class="n">hold_shutters</span><span class="o">=</span><span class="n">hold_shutter_open</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_img_beam</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">IMG_FULL</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_power</span><span class="p">,</span>
                                <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_power</span><span class="p">,</span> <span class="n">hold_shutters</span><span class="o">=</span><span class="n">hold_shutter_open</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span></div>


    <span class="c1">#Which arguments are actually necessary to pass or even set as a defualt?</span>
    <span class="c1">#How many of them can just be set to globals?</span>
    <span class="c1"># TODO: Maybe pass the shutter config into here? This would get rid of all the if statements?</span>
<div class="viewcode-block" id="MOTSequence.do_molasses_dipole_trap_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_molasses_dipole_trap_imaging">[docs]</a>
    <span class="k">def</span> <span class="nf">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># define quantization axis (Whut?? This is zeroing the field, there&#39;s not quantization axis)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_B_field</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1">#Is this section needed?</span>

        <span class="c1"># Ramp to imaging frequencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">img_ta_detuning</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">img_repump_detuning</span><span class="p">))</span>
        <span class="n">t</span><span class="o">+=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span>


        <span class="n">shutter_config</span> <span class="o">=</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">select_imgaging_shutters</span><span class="p">(</span><span class="n">do_repump</span> <span class="o">=</span> <span class="n">do_repump</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span> <span class="n">shutter_config</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="p">,</span> <span class="n">hold_shutter_open</span> <span class="o">=</span> <span class="n">hold_shutter_open</span><span class="p">)</span>


        <span class="c1"># TODO: ask Lin and Michelle and max() logic and if we always want it there</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">camera_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span><span class="s2">&quot;MOT_manta&quot;</span> <span class="ow">or</span> <span class="s2">&quot;tweezer_manta&quot;</span><span class="p">:</span>
            <span class="n">exposure</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span> <span class="mf">50e-6</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;kinetix&quot;</span><span class="p">:</span>
            <span class="n">exposure</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">exposure</span><span class="p">)</span>

        <span class="c1"># Closes the aom and the specified shutters</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">exposure</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.do_molasses_in_situ_sequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_molasses_in_situ_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">do_molasses_in_situ_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># MOT loading time 500 ms</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Turn off MOT for taking background images</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>

        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.do_molasses_tof_sequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_molasses_tof_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">do_molasses_tof_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_SHUTTER_TURN_ON_TIME</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_tof_imaging_delay</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Turn off MOT for taking background images</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


    <span class="c1">#TODO: refactor this more like the do_molasses_imaging thing above</span>
<div class="viewcode-block" id="MOTSequence.do_kinetix_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_kinetix_imaging">[docs]</a>
    <span class="k">def</span> <span class="nf">do_kinetix_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">open_ta_shutter</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">open_repump_shutter</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># TODO: Change globals away from &quot;do_mot_xy_beams_during_imaging&quot; to label as in open_mot_shutters(t, label=None)</span>
        <span class="k">if</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">open_mot_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_beam_imaging_label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">open_img_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_beam_imaging_label</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># pulse for the second shots and wait for the first shot to finish the</span>
            <span class="c1"># first reading</span>
            <span class="n">kinetix_readout_time</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">kinetix_roi_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">4.7065e-6</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;kinetix readout time:&#39;</span><span class="p">,</span> <span class="n">kinetix_readout_time</span><span class="p">)</span>
            <span class="c1"># need extra 7 ms for shutter to close on the second shot</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">kinetix_readout_time</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">kinetix_extra_readout_time</span>

            <span class="c1"># TODO: was previously called &quot;do_shutter_close_on_second_shot&quot; but this is a confusing name so</span>
            <span class="c1"># we need to change it in the globals files to what is written here:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">shutter_close_after_first_shot</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">open_mot_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_beam_imaging_label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">open_img_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_beam_imaging_label</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">mot_aom_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># TODO: what does this assert mean?</span>
        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Imaging exposure time = 0, &quot;</span>
                                                    <span class="s2">&quot;did you forget to adjust &quot;</span>
                                                    <span class="s2">&quot;for the case?&quot;</span><span class="p">)</span>

        <span class="c1">#Replace with camera object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="s2">&quot;kinetix&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_kinetix_camera</span><span class="p">:</span>
            <span class="n">exposure</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">exposure</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">exposure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">mot_aom_off</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shot_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">shutter_close_after_first_shot</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">close_mot_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_beam_imaging_label</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">close_img_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_beam_imaging_label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>
</div>




<div class="viewcode-block" id="TweezerSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence">[docs]</a>
<span class="k">class</span> <span class="nc">TweezerSequence</span><span class="p">(</span><span class="n">MOTSequence</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TweezerSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span> <span class="o">=</span> <span class="n">TweezerLaser</span><span class="p">()</span></div>



<span class="c1"># I think we should leave both 456 and 1064 stuff here because really the only debugging</span>
<span class="c1"># we would need to do is checking their overlap or looking for a Rydberg loss signal in the dipole trap</span>
<div class="viewcode-block" id="RydSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.RydSequence">[docs]</a>
<span class="k">class</span> <span class="nc">RydSequence</span><span class="p">(</span><span class="n">TweezerSequence</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RydSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span> <span class="o">=</span> <span class="n">RydLasers</span><span class="p">()</span>

<div class="viewcode-block" id="RydSequence.pulse_blue">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.RydSequence.pulse_blue">[docs]</a>
    <span class="k">def</span> <span class="nf">pulse_blue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RydSequence.pulse_1064">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.RydSequence.pulse_1064">[docs]</a>
    <span class="k">def</span> <span class="nf">pulse_1064</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">):</span>
        <span class="k">pass</span></div>
</div>




<span class="c1">#Full Sequences, we&#39;ll see if we really want all these in a class or just separate sequence files?</span>
<div class="viewcode-block" id="ScienceSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.ScienceSequence">[docs]</a>
<span class="k">class</span> <span class="nc">ScienceSequence</span><span class="p">(</span><span class="n">RydSequence</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ScienceSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>


<span class="c1">#Should we separate this from ScienceSequence?</span>
<div class="viewcode-block" id="DiagnosticSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.DiagnosticSequence">[docs]</a>
<span class="k">class</span> <span class="nc">DiagnosticSequence</span><span class="p">(</span><span class="n">RydSequence</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DiagnosticSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>




<span class="c1">#sequences functions without classes</span>
<span class="c1">#-------------------------------------------------------------------------------</span>



<span class="c1">#Old sequence functions</span>
<div class="viewcode-block" id="load_molasses">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.load_molasses">[docs]</a>
<span class="k">def</span> <span class="nf">load_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_bm_detuning</span><span class="p">,</span> <span class="n">repump_bm_detuning</span><span class="p">,</span>
                  <span class="n">ta_last_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">):</span>  <span class="c1"># -100</span>
    <span class="c1">#Ramp TA and repump VCO</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
        <span class="c1"># -190 MHz from Rydberg lab, -100 MHz from Aidelsburger&#39;s group, optimized around -200 MHz</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_bm_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="c1"># doesn&#39;t play any significant effect</span>
        <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_bm_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_power</span><span class="p">,</span>
        <span class="c1"># 0.16, #0.15, # optimized on both temperature and atom number, too low</span>
        <span class="c1"># power will lead to small atom number</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_power</span><span class="p">,</span>  <span class="c1"># doesn&#39;t play any significant effect</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ramp to zero field calibrated by microwaves</span>
    <span class="c1"># ramp the bias coil from MOT loading field to molasses field</span>
    <span class="c1"># devices.x_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=0,</span>
    <span class="c1">#         final= 0.46968,#shot_globals.x_coil_voltage,</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.y_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=0,</span>
    <span class="c1">#         final=0,#shot_globals.y_coil_voltage,</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.z_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=0,</span>
    <span class="c1">#         final=0.77068,#shot_globals.z_coil_voltage,</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bias x:&#39;</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
          <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> bias y:&#39;</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
          <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> bias z:&#39;</span><span class="p">,</span> <span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t_x_coil</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_x_coil</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t_x_coil</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span><span class="p">,</span>
            <span class="c1"># TODO: is this correct? not biasy_calib?</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasy_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t_z_coil</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_z_coil</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t_z_coil</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># devices.x_coil_current.constant(t, biasx_calib(0))</span>
    <span class="c1"># devices.y_coil_current.constant(t, biasy_calib(0))</span>
    <span class="c1"># devices.z_coil_current.constant(t, biasz_calib(0))</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_detuning</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Molasses stage&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ta_last_detuning = </span><span class="si">{</span><span class="n">ta_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;repump_last_detuning = </span><span class="si">{</span><span class="n">repump_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="load_molasses_img_beam">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.load_molasses_img_beam">[docs]</a>
<span class="k">def</span> <span class="nf">load_molasses_img_beam</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_bm_detuning</span><span class="p">,</span> <span class="n">repump_bm_detuning</span><span class="p">):</span>  <span class="c1"># -100</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">),</span>
        <span class="c1"># -190 MHz from Rydberg lab, -100 MHz from Aidelsburger&#39;s group, optimized around -200 MHz</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_bm_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="c1"># doesn&#39;t play any significant effect</span>
        <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_bm_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_ta_power</span><span class="p">,</span>
        <span class="c1"># 0.16, #0.15, # optimized on both temperature and atom number, too low</span>
        <span class="c1"># power will lead to small atom number</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_repump_power</span><span class="p">,</span>  <span class="c1"># doesn&#39;t play any significant effect</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ramp to zero field calibrated by microwaves</span>
    <span class="c1"># ramp the bias coil from MOT loading field to molasses field</span>
    <span class="c1"># devices.x_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=0,</span>
    <span class="c1">#         final= 0.46968,#shot_globals.x_coil_voltage,</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.y_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=0,</span>
    <span class="c1">#         final=0,#shot_globals.y_coil_voltage,</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.z_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=0,</span>
    <span class="c1">#         final=0.77068,#shot_globals.z_coil_voltage,</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.x_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=shot_globals.mot_x_coil_voltage,</span>
    <span class="c1">#         final= biasx_calib(0),# 0 mG</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.y_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=shot_globals.mot_y_coil_voltage,</span>
    <span class="c1">#         final= biasy_calib(0),# 0 mG</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.z_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=shot_globals.mot_z_coil_voltage,</span>
    <span class="c1">#         final= biasz_calib(0),# 0 mG</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1"># devices.x_coil_current.constant(t, biasx_calib(0))</span>
    <span class="c1"># devices.y_coil_current.constant(t, biasy_calib(0))</span>
    <span class="c1"># devices.z_coil_current.constant(t, biasz_calib(0))</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t_x_coil</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_x_coil</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t_x_coil</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span><span class="p">,</span>
            <span class="c1"># TODO: compare to statement below, is this correct?</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasy_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t_z_coil</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="mf">4e-3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_z_coil</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t_z_coil</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_repump_detuning</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Molasses stage&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ta_last_detuning = </span><span class="si">{</span><span class="n">ta_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;repump_last_detuning = </span><span class="si">{</span><span class="n">repump_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<span class="c1">#Replaced with initialization of sequence object</span>
<div class="viewcode-block" id="setup_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.setup_mot">[docs]</a>
<span class="k">def</span> <span class="nf">setup_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_coil_ctrl_voltage</span><span class="p">):</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">))</span>  <span class="c1"># 16 MHz red detuned</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">repump_freq_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># on resonance</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span><span class="p">)</span>

    <span class="c1"># 1/6 V/A, do not change to too high which may burn the coil</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_coil_ctrl_voltage</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span></div>


<span class="c1"># def initialize_lab(t):</span>
<span class="c1">#     # set the coil and vco to mot setting</span>
<span class="c1">#     devices.uwave_dds_switch.go_high(t)</span>
<span class="c1">#     devices.uwave_absorp_switch.go_low(t)</span>

<div class="viewcode-block" id="do_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_mot">[docs]</a>
<span class="k">def</span> <span class="nf">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">):</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">uwave_dds_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_uv</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uv_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uv_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span>
        <span class="c1"># longer time will lead to the overall MOT atom number decay during the</span>
        <span class="c1"># cycle</span>

    <span class="n">setup_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_coil_ctrl_voltage</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">do_mot_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="ow">not</span>
                    <span class="n">close_shutter</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">dur</span>

    <span class="k">if</span> <span class="n">close_shutter</span><span class="p">:</span>
        <span class="n">close_mot_shutters</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span></div>



<div class="viewcode-block" id="do_mot_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_mot_imaging">[docs]</a>
<span class="k">def</span> <span class="nf">do_mot_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp to imaging</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">do_mot_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_exposure_time</span><span class="p">,</span>
                     <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span> <span class="n">hold_shutter_open</span><span class="o">=</span><span class="ow">not</span> <span class="n">close_shutter</span><span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_mot</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
        <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
        <span class="n">exposure_time</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_exposure_time</span><span class="p">)</span></div>



<span class="c1">#Do we need this one?</span>
<div class="viewcode-block" id="reset_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.reset_mot">[docs]</a>
<span class="k">def</span> <span class="nf">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time in diagnostics python </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp to MOT loading</span>

    <span class="c1"># set the default value into MOT loading value</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_coil</span><span class="p">:</span>
        <span class="n">load_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">load_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">,</span>
                 <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># devices.uv_switch.go_low(t)</span>
    <span class="k">return</span> <span class="n">t</span></div>



<div class="viewcode-block" id="do_molasses">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_molasses">[docs]</a>
<span class="k">def</span> <span class="nf">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span><span class="p">,</span>
                <span class="n">repump_last_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_img_beam</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_mot_beam</span><span class="p">),</span> <span class="s2">&quot;either do_molasses_img_beam or do_molasses_mot_beam has to be on&quot;</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_mot_beam</span><span class="p">:</span>
        <span class="c1"># TODO: what does this assert statement mean?</span>
        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bright molasses detuning = 0, did you forget to correct for the new case?&quot;</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">load_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_detuning</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="n">ta_last_detuning</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;molasses detuning is </span><span class="si">{</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># turn off coil and light for TOF measurement, coil is already off in</span>
        <span class="c1"># load_molasses</span>
        <span class="k">if</span> <span class="n">close_shutter</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_img_beam</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># TODO: what does this assert statement mean?</span>
        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bright molasses detuning = 0, did you forget to correct for the new case ?&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">load_molasses_img_beam</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_ta_detuning</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_repump_detuning</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close_shutter</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>

    <span class="c1"># turn off coil and light for TOF measurement, coil is already off in</span>
    <span class="c1"># load_molasses</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="do_molasses_dipole_trap_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_molasses_dipole_trap_imaging">[docs]</a>
<span class="k">def</span> <span class="nf">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">ta_last_detuning</span><span class="p">,</span>
        <span class="n">repump_last_detuning</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_ta_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span>
        <span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_repump</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_mot_beam</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
            <span class="c1"># ta_freq_calib(shot_globals.bm_ta_detuning),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">img_ta_detuning</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="c1"># repump_freq_calib(shot_globals.bm_repump_detuning),</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_last_detuning</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">img_repump_detuning</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_img_beam</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="c1"># ta_freq_calib(shot_globals.bm_img_ta_detuning),</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">img_ta_detuning</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="c1"># repump_freq_calib(shot_globals.bm_img_repump_detuning),</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_last_detuning</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">img_repump_detuning</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">img_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">img_repump_detuning</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_in_situ_check</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># set ta and repump to full power</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_camera</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_mot</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
            <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">exposure</span><span class="p">,</span> <span class="mf">50e-6</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_camera_trigger</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_camera_trigger</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_camera</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_tweezer</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
            <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">exposure</span><span class="p">,</span> <span class="mf">50e-6</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># send a trigger to a local manta camera: (mot camera or blue laser</span>
        <span class="c1"># camera)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_camera_trigger</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_camera_trigger</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_kinetix_camera</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">kinetix</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
            <span class="s1">&#39;Kinetix&#39;</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">exposure</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;t after exposure&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exposure time&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">exposure</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">))</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">exposure</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">close_shutter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>




<span class="c1"># def do_imaging_beam_pulse(t, *, img_ta_detuning = 0, img_repump_detuning = 0, img_ta_power = 1, img_repump_power = 1, exposure = shot_globals.bm_exposure_time, close_shutter = True):</span>
<div class="viewcode-block" id="do_imaging_beam_pulse">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_imaging_beam_pulse">[docs]</a>
<span class="k">def</span> <span class="nf">do_imaging_beam_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">):</span>

    <span class="n">blue_detuning</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
        <span class="c1"># ta_freq_calib(shot_globals.bm_img_ta_detuning),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">blue_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="c1"># repump_freq_calib(shot_globals.bm_img_repump_detuning),</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_last_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">blue_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># devices.img_z_shutter.open(t)</span>
    <span class="c1"># if shot_globals.do_img_xy_beams_during_imaging:</span>
    <span class="c1">#     devices.img_xy_shutter.open(t)</span>
    <span class="c1"># if shot_globals.do_img_z_beam_during_imaging:</span>
    <span class="c1">#     devices.img_z_shutter.open(t)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># set ta and repump to full power</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_pulse_time</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_xy_beams_during_imaging</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_z_beam_during_imaging</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-3</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">blue_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_ta_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">-</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">blue_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_repump_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_img_repump_detuning</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="turn_on_dipole_trap">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.turn_on_dipole_trap">[docs]</a>
<span class="k">def</span> <span class="nf">turn_on_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">pulse_1064_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">pulse_1064_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="turn_off_dipole_trap">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.turn_off_dipole_trap">[docs]</a>
<span class="k">def</span> <span class="nf">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">pulse_1064_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">pulse_1064_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="pre_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.pre_imaging">[docs]</a>
<span class="k">def</span> <span class="nf">pre_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">):</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># define quantization axis</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_last_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging ta power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging repump power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="c1"># back to full power for imaging</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;preimaging stage&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ta_last_detuning = </span><span class="si">{</span><span class="n">ta_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;repump_last_detuning = </span><span class="si">{</span><span class="n">repump_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="robust_loading_pulse">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.robust_loading_pulse">[docs]</a>
<span class="k">def</span> <span class="nf">robust_loading_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">):</span>
    <span class="c1"># TODO: rename this function, what is robust about this?</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">dur</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span></div>



<div class="viewcode-block" id="parity_projection_pulse">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.parity_projection_pulse">[docs]</a>
<span class="k">def</span> <span class="nf">parity_projection_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">):</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_ta_detuning</span><span class="p">),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to imaging</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_ta_power</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parity projection stage&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ta_last_detuning = </span><span class="si">{</span><span class="n">ta_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;repump_last_detuning = </span><span class="si">{</span><span class="n">repump_last_detuning</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">dur</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="do_blue">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_blue">[docs]</a>
<span class="k">def</span> <span class="nf">do_blue</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">blue_power</span><span class="p">):</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">blue_456_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">octagon_456_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">blue_power</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">octagon_456_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># devices.optical_pump_shutter.open(t)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mf">10e-6</span><span class="p">,</span>
                                       <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_repump_power</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">octagon_456_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">octagon_456_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
    <span class="c1"># devices.optical_pump_shutter.close(t+dur)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">blue_456_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dur</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span></div>



<div class="viewcode-block" id="do_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_imaging">[docs]</a>
<span class="k">def</span> <span class="nf">do_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">):</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># pulse for the second shots and wait for the first shot to finish the</span>
        <span class="c1"># first reading</span>
        <span class="n">kinetix_readout_time</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">kinetix_roi_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">4.7065e-6</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;kinetix readout time:&#39;</span><span class="p">,</span> <span class="n">kinetix_readout_time</span><span class="p">)</span>
        <span class="c1"># need extra 7 ms for shutter to close on the second shot</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">kinetix_readout_time</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">kinetix_extra_readout_time</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_shutter_close_on_second_shot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_xy_beams_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_z_beam_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># if shot_globals.do_tweezer_camera:</span>
    <span class="c1">#     devices.manta419b_tweezer.expose(</span>
    <span class="c1">#         &#39;manta419b&#39;,</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         &#39;atoms&#39;,</span>
    <span class="c1">#         exposure_time=max(shot_globals.manta_exposure, 50e-6),</span>
    <span class="c1">#     )</span>

    <span class="c1">#     t +=  shot_globals.manta_exposure</span>
    <span class="c1">#     devices.repump_aom_digital.go_low(t)</span>
    <span class="c1">#     devices.ta_aom_digital.go_low(t)</span>
    <span class="c1"># TODO: what does this assert mean?</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Imaging exposure time = 0, &quot;</span>
                                                 <span class="s2">&quot;did you forget to adjust &quot;</span>
                                                 <span class="s2">&quot;for the case?&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_kinetix_camera</span><span class="p">:</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">kinetix</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
            <span class="s1">&#39;Kinetix&#39;</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># do this when not using kinetix server (take picture locally)</span>
        <span class="c1"># devices.kinetix_camera_trigger.go_high(t)</span>
        <span class="c1"># devices.kinetix_camera_trigger.go_low(t+shot_globals.img_exposure_time)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span>

    <span class="c1"># if shot_globals.do_tweezer_camera:</span>
    <span class="c1">#     devices.manta419b_tweezer.expose(</span>
    <span class="c1">#         &#39;manta419b&#39;,</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         &#39;atoms&#39;,</span>
    <span class="c1">#         exposure_time=max(exposure, 50e-6),</span>
    <span class="c1">#     )</span>

    <span class="c1">#     # send a trigger to a local manta camera: (mot camera or blue laser camera)</span>
    <span class="c1">#     devices.mot_camera_trigger.go_high(t)</span>
    <span class="c1">#     devices.mot_camera_trigger.go_low(t+shot_globals.bm_exposure_time)</span>

    <span class="c1">#     t += exposure</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># TODO: replace sections like this with a function literal</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_shutter_close_on_second_shot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_xy_beams_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_z_beam_during_imaging</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beams_during_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_xy_beams_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_z_beam_during_imaging</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="optical_pumping">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.optical_pumping">[docs]</a>
<span class="k">def</span> <span class="nf">optical_pumping</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">ta_last_detuning</span><span class="p">,</span>
        <span class="n">repump_last_detuning</span><span class="p">,</span>
        <span class="n">next_step</span><span class="o">=</span><span class="s1">&#39;microwave&#39;</span><span class="p">):</span>
    <span class="n">ta_pumping_detuning</span> <span class="o">=</span> <span class="o">-</span><span class="mi">251</span>  <span class="c1"># MHz 4-&gt;4 tansition</span>
    <span class="n">repump_depumping_detuning</span> <span class="o">=</span> <span class="o">-</span><span class="mf">201.24</span>  <span class="c1"># MHz 3-&gt;3 transition</span>
    <span class="n">repump_pumping_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_pumping_detuning</span>
    <span class="n">ta_vco_stable_t</span> <span class="o">=</span> <span class="mf">1e-4</span>  <span class="c1"># stable time waited for lock</span>

    <span class="k">if</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s1">&#39;microwave&#39;</span><span class="p">:</span>
        <span class="n">final_biasx_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasx_field</span>
        <span class="n">final_biasy_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasy_field</span>
        <span class="n">final_biasz_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasz_field</span>
    <span class="k">elif</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s1">&#39;rydberg&#39;</span><span class="p">:</span>
        <span class="n">final_biasx_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_biasx_field</span>
        <span class="n">final_biasy_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_biasy_field</span>
        <span class="n">final_biasz_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_biasz_field</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This next step is not defined in the function.&quot;</span><span class="p">)</span>

    <span class="c1">######## pump all atom into F=4 using MOT beams ###########</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_optical_pump_MOT</span><span class="p">:</span>
        <span class="n">do_optical_pump_beam</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m doing optical pumping now using MOT beams&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_optical_pump_beam</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_MOT_op_time</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_optical_pump_beam</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">final_biasx_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasy_calib</span><span class="p">(</span><span class="n">final_biasy_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">final_biasz_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">ta_last_detuning</span>
        <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">repump_last_detuning</span>

    <span class="c1"># depump all atom into F = 3 level by using MOT beams F = 4 -&gt; F&#39; =</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_optical_depump_MOT</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m doing optical de pumping now using MOT beams&quot;</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_pumping_detuning</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">ta_pumping_detuning</span>
        <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">repump_last_detuning</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span> <span class="o">+</span> <span class="n">ta_vco_stable_t</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># at time t shutter already fully open</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_MOT_odp_time</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># there will be lekage light because at time t shutter only start to</span>
        <span class="c1"># close</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">final_biasx_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasy_calib</span><span class="p">(</span><span class="n">final_biasy_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">final_biasz_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">####### depump all atom into F = 3, mF =3 level by using sigma+ beam #####</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_optical_depump_sigma_plus</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m doing optical de pumping now using sigma+ beams&quot;</span><span class="p">)</span>

        <span class="n">op_biasx_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_amp</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_phi</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_theta</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">op_biasy_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_amp</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_phi</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_theta</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">op_biasz_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_amp</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_theta</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">op_biasx_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># devices.y_coil_current.ramp(</span>
        <span class="c1">#         t,</span>
        <span class="c1">#         duration=100e-6,</span>
        <span class="c1">#         initial=biasx_calib(0),</span>
        <span class="c1">#         final=  biasy_calib(shot_globals.op_biasy_field),# 0 mG</span>
        <span class="c1">#         samplerate=1e5,</span>
        <span class="c1">#     )</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span>
            <span class="n">op_biasy_field</span><span class="p">))</span>  <span class="c1"># define quantization axis</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">op_biasz_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_pumping_detuning</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_last_detuning</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_depumping_detuning</span><span class="p">),</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ta_shutter_off_t</span> <span class="o">=</span> <span class="mf">1.74e-3</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="mf">100e-6</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ramp_delay</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_power</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_power</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_time</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_time</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_time</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span> <span class="o">&gt;</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_time</span><span class="p">,</span> <span class="s2">&quot;TA time should be longer than repump for atom in F = 3&quot;</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_time</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">op_biasx_field</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">final_biasx_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># devices.y_coil_current.ramp(</span>
        <span class="c1">#         t,</span>
        <span class="c1">#         duration=100e-6,</span>
        <span class="c1">#         initial=biasx_calib(shot_globals.op_biasy_field),</span>
        <span class="c1">#         final=  biasy_calib(shot_globals.biasy_field),# 0 mG</span>
        <span class="c1">#         samplerate=1e5,</span>
        <span class="c1">#     )</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span>
            <span class="n">final_biasy_field</span><span class="p">))</span>  <span class="c1"># define quantization axis</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">op_biasz_field</span><span class="p">),</span>
            <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">final_biasz_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># print(</span>
        <span class="c1">#     f&#39;OP bias x, y, z voltage = {</span>
        <span class="c1">#         biasx_calib(op_biasx_field)}, {</span>
        <span class="c1">#         biasy_calib(op_biasy_field)}, {</span>
        <span class="c1">#         biasz_calib(op_biasz_field)}&#39;)</span>

        <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">ta_pumping_detuning</span>
        <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">repump_depumping_detuning</span>

    <span class="c1">##### pump all atom into F = 4, mF = 4 level by using sigma+ beam #########</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_optical_pump_sigma_plus</span><span class="p">:</span>  <span class="c1"># use sigma + polarized light for optical pumping</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m doing optical pumping now using sigma+ beams&quot;</span><span class="p">)</span>
        <span class="n">do_comparison_with_optical_pump_MOT</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ta_shutter_off_t</span> <span class="o">=</span> <span class="mf">1.74e-3</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">img_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">img_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">mot_coil_current_ctrl</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_comparison_with_optical_pump_MOT</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># devices.ta_shutter.close(t)</span>
            <span class="c1"># devices.repump_shutter.close(t)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">ta_shutter_off_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">op_biasx_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_amp</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_phi</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_theta</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">op_biasy_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_amp</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_phi</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_theta</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">op_biasz_field</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_amp</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_theta</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">op_biasx_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span><span class="n">op_biasy_field</span><span class="p">))</span>  <span class="c1"># define quantization axis</span>

            <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">op_biasz_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
                <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_pumping_detuning</span><span class="p">),</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">devices</span><span class="o">.</span><span class="n">repump_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_last_detuning</span><span class="p">),</span>
                <span class="n">final</span><span class="o">=</span><span class="n">repump_freq_calib</span><span class="p">(</span><span class="n">repump_pumping_detuning</span><span class="p">),</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">ta_pumping_detuning</span>
            <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">repump_pumping_detuning</span>

            <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="mf">100e-6</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ramp_delay</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_power</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_power</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_depump_pulse_after_pumping</span><span class="p">:</span>
            <span class="c1"># do not close the TA shutter, pulsing the TA AOM for measuring</span>
            <span class="c1"># dark states</span>
            <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span> <span class="o">&lt;</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">,</span> <span class="s2">&quot;TA time should be shorter than repump for atom in F = 4&quot;</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">)</span>
            <span class="c1"># devices.ta_shutter.open(t)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 0.3)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_depump_pulse_time</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span> <span class="o">&lt;</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">,</span> <span class="s2">&quot;TA time should be shorter than repump for atom in F = 4&quot;</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_comparison_with_optical_pump_MOT</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">op_biasx_field</span><span class="p">),</span>
                <span class="n">final</span><span class="o">=</span><span class="n">biasx_calib</span><span class="p">(</span><span class="n">final_biasx_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># devices.y_coil_current.ramp(</span>
            <span class="c1">#         t,</span>
            <span class="c1">#         duration=100e-6,</span>
            <span class="c1">#         initial=biasx_calib(shot_globals.op_biasy_field),</span>
            <span class="c1">#         final=  biasy_calib(shot_globals.biasy_field),# 0 mG</span>
            <span class="c1">#         samplerate=1e5,</span>
            <span class="c1">#     )</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span><span class="n">final_biasy_field</span><span class="p">))</span>  <span class="c1"># define quantization axis</span>

            <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
                <span class="n">initial</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">op_biasz_field</span><span class="p">),</span>
                <span class="n">final</span><span class="o">=</span><span class="n">biasz_calib</span><span class="p">(</span><span class="n">final_biasz_field</span><span class="p">),</span>  <span class="c1"># 0 mG</span>
                <span class="n">samplerate</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># print(</span>
            <span class="c1">#     f&#39;OP bias x, y, z voltage = {</span>
            <span class="c1">#         biasx_calib(op_biasx_field)}, {</span>
            <span class="c1">#         biasy_calib(op_biasy_field)}, {</span>
            <span class="c1">#         biasz_calib(op_biasz_field)}&#39;)</span>

    <span class="c1"># ###### pump all atom into F = 4, mF = 4 level by using sigma+ beam #####</span>
    <span class="c1"># if shot_globals.do_optical_pump_sigma_plus: # use sigma + polarized light for optical pumping</span>
    <span class="c1">#     print(&quot;I&#39;m doing optical pumping now using sigma+ beams&quot;)</span>
    <span class="c1">#     devices.mot_xy_shutter.close(t)</span>
    <span class="c1">#     devices.mot_z_shutter.close(t)</span>
    <span class="c1">#     devices.img_xy_shutter.close(t)</span>
    <span class="c1">#     devices.img_z_shutter.close(t)</span>
    <span class="c1">#     devices.ta_aom_digital.go_low(t)</span>
    <span class="c1">#     devices.mot_coil_current_ctrl.constant(t, 0)</span>
    <span class="c1">#     devices.ta_shutter.close(t-3e-3)</span>
    <span class="c1">#     devices.optical_pump_shutter.open(t)</span>
    <span class="c1">#     devices.ta_aom_analog.constant(t, shot_globals.op_ta_power)</span>
    <span class="c1">#     devices.repump_shutter.open(t)</span>
    <span class="c1">#     devices.repump_aom_digital.go_high(t)</span>
    <span class="c1">#     devices.repump_aom_analog.constant(t, shot_globals.op_repump_power)</span>

    <span class="c1">#     devices.ta_aom_digital.go_low(t + shot_globals.op_ta_time)</span>
    <span class="c1">#     devices.repump_aom_digital.go_low(t + shot_globals.op_repump_time)</span>
    <span class="c1">#     devices.repump_shutter.close(t + shot_globals.op_repump_time)</span>
    <span class="c1">#     devices.ta_shutter.close(t + shot_globals.op_ta_time)</span>
    <span class="c1">#     assert shot_globals.op_ta_time &lt; shot_globals.op_repump_time, &quot;TA time should be shorter than repump for atom in F = 4&quot;</span>
    <span class="c1">#     t += max(shot_globals.op_ta_time, shot_globals.op_repump_time)</span>
    <span class="c1">#     devices.optical_pump_shutter.close(t)</span>
    <span class="c1">#     devices.x_coil_current.ramp(</span>
    <span class="c1">#         t,</span>
    <span class="c1">#         duration=100e-6,</span>
    <span class="c1">#         initial=biasx_calib(0),</span>
    <span class="c1">#         final= biasx_calib(final_biasx_field),# 0 mG</span>
    <span class="c1">#         samplerate=1e5,</span>
    <span class="c1">#     )</span>

    <span class="c1">#     devices.y_coil_current.ramp(</span>
    <span class="c1">#             t,</span>
    <span class="c1">#             duration=100e-6,</span>
    <span class="c1">#             initial=biasx_calib(0),</span>
    <span class="c1">#             final=  biasy_calib(final_biasy_field),# 0 mG</span>
    <span class="c1">#             samplerate=1e5,</span>
    <span class="c1">#         )</span>

    <span class="c1">#     devices.z_coil_current.ramp(</span>
    <span class="c1">#             t,</span>
    <span class="c1">#             duration=100e-6,</span>
    <span class="c1">#             initial=biasz_calib(0),</span>
    <span class="c1">#             final= biasz_calib(final_biasz_field),# 0 mG</span>
    <span class="c1">#             samplerate=1e5,</span>
    <span class="c1">#         )</span>

    <span class="c1">#     ta_last_detuning = ta_last_detuning</span>
    <span class="c1">#     repump_last_detuning = repump_last_detuning</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="killing_pulse">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.killing_pulse">[docs]</a>
<span class="k">def</span> <span class="nf">killing_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">):</span>
    <span class="c1"># ==================== Use a strong killing pulse to kick all atoms in F=4 out =======================#</span>
    <span class="n">time_offset</span> <span class="o">=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span> <span class="o">+</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">repump_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">repump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_xy_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mot_z_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_vco</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="n">ta_last_detuning</span><span class="p">),</span>
        <span class="n">final</span><span class="o">=</span><span class="n">ta_freq_calib</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># -45), #ta_bm_detuning),</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># shutter fully open. killing pulse starts at time t</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_ta_power</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">optical_pump_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ta_shutter</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># -45</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">repump_last_detuning</span>

    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span></div>



<div class="viewcode-block" id="spectrum_microwave_sweep">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.spectrum_microwave_sweep">[docs]</a>
<span class="k">def</span> <span class="nf">spectrum_microwave_sweep</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">uwave_clock</span> <span class="o">=</span> <span class="mf">9.192631770e3</span>  <span class="c1"># in unit of MHz</span>
    <span class="n">local_oscillator_freq_mhz</span> <span class="o">=</span> <span class="mi">9486</span>  <span class="c1"># in unit of MHz MKU LO 8-13 PLL setting</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep_starttoend</span><span class="p">:</span>
        <span class="n">mw_freq_start</span> <span class="o">=</span> <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span> \
            <span class="n">uwave_clock</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning_start</span>
        <span class="n">mw_freq_end</span> <span class="o">=</span> <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span> \
            <span class="n">uwave_clock</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning_end</span>
        <span class="n">mw_sweep_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mw_freq_end</span> <span class="o">-</span> <span class="n">mw_freq_start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep_duration</span><span class="p">:</span>
            <span class="n">mw_sweep_duration</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mw_sweep_duration</span> <span class="o">=</span> <span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_rate</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="n">spectrum_card_offset</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">mw_sweep_duration</span><span class="p">,</span>
            <span class="n">start_freq</span><span class="o">=</span><span class="n">mw_freq_start</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">end_freq</span><span class="o">=</span><span class="n">mw_freq_end</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">freq_ramp_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="c1"># print(f&#39;Start the sweep from {shot_globals.mw_detuning_start} MHz to {</span>
        <span class="c1">#       shot_globals.mw_detuning_end} MHz within {mw_sweep_duration}s &#39;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mw_sweep_range</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_range</span>
        <span class="n">mw_detuning_center</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning_center</span>
        <span class="n">mw_freq_center</span> <span class="o">=</span> <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span> <span class="n">uwave_clock</span> <span class="o">-</span> <span class="n">mw_detuning_center</span>
        <span class="n">mw_freq_start</span> <span class="o">=</span> <span class="n">mw_freq_center</span> <span class="o">-</span> <span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">mw_freq_end</span> <span class="o">=</span> <span class="n">mw_freq_center</span> <span class="o">+</span> <span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep_duration</span><span class="p">:</span>
            <span class="n">mw_sweep_duration</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mw_sweep_duration</span> <span class="o">=</span> <span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_rate</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span> <span class="n">spectrum_card_offset</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">mw_sweep_duration</span><span class="p">,</span>
            <span class="n">start_freq</span><span class="o">=</span><span class="n">mw_freq_start</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">end_freq</span><span class="o">=</span><span class="n">mw_freq_end</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">freq_ramp_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="c1"># print(f&#39;Sweep around center {shot_globals.mw_sweep_range} MHz for a range of {</span>
        <span class="c1">#       shot_globals.mw_detuning_end} MHz within {mw_sweep_duration}s &#39;)</span>

    <span class="k">return</span> <span class="n">mw_sweep_duration</span></div>



<div class="viewcode-block" id="intensity_servo_keep_on">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.intensity_servo_keep_on">[docs]</a>
<span class="k">def</span> <span class="nf">intensity_servo_keep_on</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="c1"># keep the AOM digital high for intensity servo</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">ipg_1064_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">moglabs_456_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_mot_in_situ_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_mot_in_situ_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_mot_in_situ_check</span><span class="p">():</span>
    <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">close_aom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">mot_load_dur</span>  <span class="c1"># MOT loading time 500 ms</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_COIL_OFF_TIME</span>  <span class="c1"># wait for the coil fully off</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">do_mot_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">use_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Turn off MOT for taking background images</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.1</span>  <span class="c1"># Wait until the MOT disappear</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">do_mot_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">use_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running do_mot_in_situ_check&quot;</span><span class="p">)</span>
    <span class="c1"># set back to initial value</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_mot_tof_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_mot_tof_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_mot_tof_check</span><span class="p">():</span>
    <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">close_aom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">mot_load_dur</span>  <span class="c1"># MOT loading time 500 ms</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_tof_imaging_delay</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">do_mot_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">use_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Turn off MOT for taking background images</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.1</span>  <span class="c1"># Wait until the MOT disappear</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">do_mot_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">use_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># set back to initial value</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_molasses_in_situ_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_molasses_in_situ_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_molasses_in_situ_check</span><span class="p">():</span>
    <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># if shot_globals.do_tweezers:</span>
    <span class="c1">#     print(&quot;Initializing tweezers&quot;)</span>
    <span class="c1">#     devices.dds0.synthesize(t+1e-2, shot_globals.TW_y_freqs, 0.95, 0)</span>
    <span class="c1">#     spectrum_manager.start_card()</span>
    <span class="c1">#     t1 = spectrum_manager.start_tweezers(t) #has to be the first thing in the timing sequence (?)</span>
    <span class="c1">#     print(&#39;tweezer start time:&#39;,t1)</span>
    <span class="c1">#     # Turn on the tweezer</span>
    <span class="c1">#     devices.tweezer_aom_digital.go_high(t)</span>
    <span class="c1">#     devices.tweezer_aom_analog.constant(t, 1) #0.3) #for single tweezer</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap</span><span class="p">:</span>
        <span class="n">turn_on_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">close_aom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">mot_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span>  <span class="c1"># account for the ramp before imaging</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span>
        <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_ta_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span>
        <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Turn off MOT for taking background images</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>
    <span class="c1"># devices.ta_aom_digital.go_low(t)</span>
    <span class="c1"># devices.repump_aom_digital.go_low(t)</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span> <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>

    <span class="c1"># if shot_globals.do_tweezers:</span>
    <span class="c1">#     # stop tweezers</span>
    <span class="c1">#     t2 = spectrum_manager.stop_tweezers(t)</span>
    <span class="c1">#     print(&#39;tweezer stop time:&#39;, t2)</span>
    <span class="c1">#     #t += 1e-3</span>

    <span class="c1">#     ##### dummy segment ######</span>
    <span class="c1">#     t1 = spectrum_manager.start_tweezers(t)</span>
    <span class="c1">#     print(&#39;tweezer start time:&#39;, t1)</span>
    <span class="c1">#     t += 2e-3</span>
    <span class="c1">#     t2 = spectrum_manager.stop_tweezers(t)</span>
    <span class="c1">#     print(&#39;tweezer stop time:&#39;,t2)</span>
    <span class="c1">#     #t += 1e-3################</span>
    <span class="c1">#     spectrum_manager.stop_card(t)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_molasses_tof_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_molasses_tof_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_molasses_tof_check</span><span class="p">():</span>
    <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.75</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">close_aom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">mot_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_tof_imaging_delay</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span> <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Turn off MOT for taking background images</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>
    <span class="c1"># devices.ta_aom_digital.go_low(t)</span>
    <span class="c1"># devices.repump_aom_digital.go_low(t)</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_tof_imaging_delay</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span> <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>

    <span class="c1"># if shot_globals.do_tweezers:</span>
    <span class="c1">#     # stop tweezers</span>
    <span class="c1">#     t2 = spectrum_manager.stop_tweezers(t)</span>
    <span class="c1">#     print(&#39;tweezer stop time:&#39;, t2)</span>
    <span class="c1">#     #t += 1e-3</span>

    <span class="c1">#     ##### dummy segment ######</span>
    <span class="c1">#     t1 = spectrum_manager.start_tweezers(t)</span>
    <span class="c1">#     print(&#39;tweezer start time:&#39;, t1)</span>
    <span class="c1">#     t += 2e-3</span>
    <span class="c1">#     t2 = spectrum_manager.stop_tweezers(t)</span>
    <span class="c1">#     print(&#39;tweezer stop time:&#39;,t2)</span>
    <span class="c1">#     #t += 1e-3################</span>
    <span class="c1">#     spectrum_manager.stop_card(t)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_field_calib_in_molasses_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_field_calib_in_molasses_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_field_calib_in_molasses_check</span><span class="p">():</span>
    <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">spectrum_uwave_cable_atten</span> <span class="o">=</span> <span class="mf">4.4</span>  <span class="c1"># dB at 300 MHz</span>
    <span class="n">spectrum_uwave_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># -3 # dBm</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># temproral for Nolan&#39;s alignment</span>
    <span class="c1"># devices.ipg_1064_aom_digital.go_high(t)</span>
    <span class="c1"># devices.ipg_1064_aom_analog.constant(t, 1)</span>
    <span class="c1"># devices.pulse_1064_analog.constant(t,1)</span>
    <span class="c1"># devices.pulse_1064_digital.go_high(t)</span>
    <span class="c1"># devices.moglabs_456_aom_analog.constant(t,0.3)</span>
    <span class="c1"># devices.moglabs_456_aom_digital.go_high(t)</span>
    <span class="c1"># devices.blue_456_shutter.open(t)</span>
    <span class="c1"># devices.octagon_456_aom_analog.constant(t,0.05)</span>
    <span class="c1"># devices.octagon_456_aom_digital.go_high(t)</span>

    <span class="c1"># ================================================================================</span>
    <span class="c1"># Spectrum card related for microwaves</span>
    <span class="c1"># ================================================================================</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">replay_mode</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
                                    <span class="n">channels</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;microwaves&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="n">spectrum_uwave_power</span> <span class="o">+</span> <span class="n">spectrum_uwave_cable_atten</span><span class="p">,</span>
                                               <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                               <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                               <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                               <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                              <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;mmwaves&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span>
                                               <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                               <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                               <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                               <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span>
                                    <span class="n">clock_freq</span><span class="o">=</span><span class="mi">625</span><span class="p">,</span>
                                    <span class="n">use_ext_clock</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">ext_clock_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">close_aom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">mot_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_detuning</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">optical_pumping</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasx_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasy_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasz_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasz_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>

    <span class="c1"># Turn on microwave</span>
    <span class="c1"># wait until the bias coils are on and the shutter is fullly closed</span>
    <span class="n">bias_coil_on_time</span> <span class="o">=</span> <span class="mf">0.5e-3</span>  <span class="c1"># minimum time for the bias coil to be on</span>
    <span class="n">shutter_ramp_time</span> <span class="o">=</span> <span class="mf">1.5e-3</span>  <span class="c1"># time for shutter to start open/close to fully open/close</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bias_coil_on_time</span><span class="p">,</span> <span class="n">shutter_ramp_time</span><span class="p">,</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
        <span class="c1"># the offset for the beging of output comparing to the trigger</span>
        <span class="n">spectrum_card_offset</span> <span class="o">=</span> <span class="mf">52.8e-6</span>
        <span class="n">uwave_clock</span> <span class="o">=</span> <span class="mf">9.192631770e3</span>  <span class="c1"># in unit of MHz</span>
        <span class="n">local_oscillator_freq_mhz</span> <span class="o">=</span> <span class="mi">9486</span>  <span class="c1"># in unit of MHz MKU LO 8-13 PLL setting</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">spectrum_card_offset</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">spectrum_card_offset</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="p">(</span>
                <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span>
                <span class="n">uwave_clock</span> <span class="o">-</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span><span class="p">)</span> <span class="o">*</span>
            <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&#39;Spectrum card freq = {</span>
        <span class="c1">#         local_oscillator_freq_mhz -</span>
        <span class="c1">#         uwave_clock -</span>
        <span class="c1">#         shot_globals.mw_detuning}&#39;)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_multi_pulse</span><span class="p">:</span>
        <span class="c1"># the offset for the beging of output comparing to the trigger</span>
        <span class="n">spectrum_card_offset</span> <span class="o">=</span> <span class="mf">52.8e-6</span>
        <span class="n">uwave_clock</span> <span class="o">=</span> <span class="mf">9.192631770e3</span>  <span class="c1"># in unit of MHz</span>
        <span class="n">local_oscillator_freq_mhz</span> <span class="o">=</span> <span class="mi">9486</span>  <span class="c1"># in unit of MHz MKU LO 8-13 PLL setting</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">spectrum_card_offset</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">spectrum_card_offset</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="p">(</span>
                <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span>
                <span class="n">uwave_clock</span> <span class="o">-</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span><span class="p">)</span> <span class="o">*</span>
            <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&#39;Spectrum card freq = {</span>
        <span class="c1">#         local_oscillator_freq_mhz -</span>
        <span class="c1">#         uwave_clock -</span>
        <span class="c1">#         shot_globals.mw_detuning}&#39;)</span>
        <span class="n">t_pulse</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span> <span class="o">/</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_num_pulses</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t_pulse = </span><span class="si">{</span><span class="n">t_pulse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="si">}</span><span class="s1">us&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t before microwave pulse = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_num_pulses</span><span class="p">):</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">t_pulse</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">t_pulse</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t after microwave pulse = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">killing_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">4e-3</span>

    <span class="c1"># assert shot_globals.bm_tof_imaging_delay &gt; min_shutter_off_t, &quot;time of flight too short for shutter&quot;</span>
    <span class="c1"># t += shot_globals.bm_tof_imaging_delay</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span> <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span> <span class="n">do_repump</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_imaging_do_repump</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Turn off MOT for taking background images</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>
    <span class="c1"># devices.ta_aom_digital.go_low(t)</span>
    <span class="c1"># devices.repump_aom_digital.go_low(t)</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="c1"># t += shot_globals.bm_tof_imaging_delay</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span> <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span> <span class="n">do_repump</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_imaging_do_repump</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">##### dummy segment ####</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
        <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># dummy segment</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_dipole_trap_tof_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_dipole_trap_tof_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_dipole_trap_tof_check</span><span class="p">():</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">intensity_servo_keep_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_1_horizontal</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_1_vertical</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_2_horizontal</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_2_vertical</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap</span><span class="p">:</span>
        <span class="n">turn_on_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_card</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezer_card</span><span class="p">()</span>
        <span class="c1"># has to be the first thing in the timing sequence (?)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">dds0</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="n">TW_y_freqs</span><span class="p">,</span>
        <span class="n">amp</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="n">ph</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># unit: MHz</span>
    <span class="c1"># devices.dds1.synthesize(t+1e-3, freq = shot_globals.blue_456_detuning, amp = 0.95, ph = 0)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer x start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="c1"># Turn on the tweezer</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># the offset for the beging of output comparing to the trigger</span>
    <span class="n">spectrum_card_offset</span> <span class="o">=</span> <span class="mf">52.8e-6</span>
    <span class="n">spectrum_uwave_cable_atten</span> <span class="o">=</span> <span class="mf">4.4</span>  <span class="c1"># dB at 300 MHz</span>
    <span class="n">spectrum_uwave_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># -3 # dBm</span>
    <span class="n">uwave_clock</span> <span class="o">=</span> <span class="mf">9.192631770e3</span>  <span class="c1"># in unit of MHz</span>
    <span class="n">local_oscillator_freq_mhz</span> <span class="o">=</span> <span class="mi">9486</span>  <span class="c1"># in unit of MHz MKU LO 8-13 PLL setting</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">replay_mode</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
                                        <span class="n">channels</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;microwaves&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="n">spectrum_uwave_power</span> <span class="o">+</span> <span class="n">spectrum_uwave_cable_atten</span><span class="p">,</span>
                                                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                                   <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                                  <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;mmwaves&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span>
                                                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                                   <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span>
                                        <span class="n">clock_freq</span><span class="o">=</span><span class="mi">625</span><span class="p">,</span>
                                        <span class="n">use_ext_clock</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">ext_clock_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 0.75</span>
    <span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">close_aom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">mot_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">optical_pumping</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasx_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasy_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasz_calib</span><span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasz_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">mw_sweep_duration</span> <span class="o">=</span> <span class="n">spectrum_microwave_sweep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">mw_sweep_duration</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">mw_sweep_duration</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">spectrum_card_offset</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">spectrum_card_offset</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="p">(</span>
                <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span>
                <span class="n">uwave_clock</span> <span class="o">-</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span><span class="p">)</span> <span class="o">*</span>
            <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&#39;Spectrum card freq = {</span>
        <span class="c1">#         local_oscillator_freq_mhz -</span>
        <span class="c1">#         uwave_clock -</span>
        <span class="c1">#         shot_globals.mw_detuning}&#39;)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
        <span class="c1"># for shutter and vco to be ready for killing pulse</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span> <span class="o">+</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">killing_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging expsorue time = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging ta power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging repump power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span>
        <span class="n">img_ta_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_detuning</span><span class="p">,</span>
        <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_ta_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span><span class="p">,</span>
        <span class="n">img_repump_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span><span class="p">,</span>
        <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span>
        <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Turn off MOT for taking background images</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>
    <span class="c1"># devices.ta_aom_digital.go_low(t)</span>
    <span class="c1"># devices.repump_aom_digital.go_low(t)</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging expsorue time = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging ta power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging repump power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span>
        <span class="n">img_ta_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_detuning</span><span class="p">,</span>
        <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_ta_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span><span class="p">,</span>
        <span class="n">img_repump_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span><span class="p">,</span>
        <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span>
        <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1">##### dummy segment ######</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1">#################</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_card</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezer_card</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_img_beam_alignment_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_img_beam_alignment_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_img_beam_alignment_check</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap</span><span class="p">:</span>
        <span class="n">turn_on_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">dds0</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_y_freqs</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_card</span><span class="p">()</span>
        <span class="c1"># has to be the first thing in the timing sequence (?)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="c1"># Turn on the tweezer</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># 1) #for single tweezer</span>

    <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">,</span> <span class="n">close_aom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">mot_coil_ctrl_voltage</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">mot_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_pulse</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging_beam_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
        <span class="c1"># t,</span>
        <span class="c1"># img_ta_detuning = shot_globals.img_ta_detuning,</span>
        <span class="c1"># img_repump_detuning = 0,</span>
        <span class="c1"># img_ta_power = shot_globals.img_ta_power,</span>
        <span class="c1"># img_repump_power = shot_globals.img_repump_power,</span>
        <span class="c1"># exposure = shot_globals.img_exposure_time,</span>
        <span class="c1"># close_shutter = True</span>
        <span class="c1"># )</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_pulse_time</span> <span class="o">+</span> <span class="mf">3e-3</span> <span class="o">+</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging expsorue time = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging ta power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging repump power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span>
        <span class="n">img_ta_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_detuning</span><span class="p">,</span>
        <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_ta_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span><span class="p">,</span>
        <span class="n">img_repump_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span><span class="p">,</span>
        <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span>
        <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Turn off MOT for taking background images</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>
    <span class="c1"># devices.ta_aom_digital.go_low(t)</span>
    <span class="c1"># devices.repump_aom_digital.go_low(t)</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging expsorue time = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging ta power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Imaging repump power = 0, did you forget to adjust for the case?&quot;</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span>
        <span class="n">img_ta_detuning</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_detuning</span><span class="p">,</span>
        <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">img_ta_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span><span class="p">,</span>
        <span class="n">img_repump_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span><span class="p">,</span>
        <span class="n">exposure</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span>
        <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1"># t += 1e-3</span>

        <span class="c1">##### dummy segment ######</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1"># t += 1e-3################</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_card</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span></div>



<div class="viewcode-block" id="do_tweezer_position_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_tweezer_position_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_tweezer_position_check</span><span class="p">():</span>
    <span class="n">check_on_vimba_viewer</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># False</span>
    <span class="c1"># look at the trap intensity distribution on the tweezer camera</span>
    <span class="c1"># look at it&#39;s relative position to the molasses</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">intensity_servo_keep_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-3</span>

    <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_card</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezer_card</span><span class="p">()</span>
        <span class="c1"># has to be the first thing in the timing sequence (?)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># devices.dds0.synthesize(t+1e-3, freq = TW_y_freqs, amp = 0.95, ph = 0) # unit: MHz</span>
    <span class="c1"># devices.dds1.synthesize(t+1e-3, freq = shot_globals.blue_456_detuning, amp = 0.95, ph = 0)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer x start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="c1"># Turn on the tweezer</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-3</span>

    <span class="n">ta_last_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_detuning</span>
    <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_rearrangement</span><span class="p">:</span>
        <span class="c1"># take image in kinetix camera for rearrangement to work (need to check</span>
        <span class="c1"># do_kinetic_camera for this to work)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">300e-3</span>  <span class="c1"># time for rearrangemeent</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_on_vimba_viewer</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">,</span> <span class="n">img_ta_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_detuning</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_ta_power</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_repump_power</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="mf">50e-6</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">5</span>  <span class="c1"># 1e-3 #10 #</span>

    <span class="c1"># devices.tweezer_aom_digital.go_low(t)</span>

    <span class="c1"># t, ta_last_detuning, repump_last_detuning = do_molasses_dipole_trap_imaging(t, ta_last_detuning, repump_last_detuning, img_ta_detuning=0, img_repump_detuning=0, img_ta_power=0, img_repump_power=0, exposure= 50e-6, close_shutter= False)</span>

    <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1">##### dummy segment ######</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1">#################</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_card</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezer_card</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_tweezer_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_tweezer_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_tweezer_check</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">MOT_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">intensity_servo_keep_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_1_horizontal</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_1_h_position</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_1_vertical</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_1_v_position</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_2_horizontal</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_2_h_position</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_2_vertical</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_2_v_position</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_sequence_mode</span><span class="p">,</span> <span class="s2">&quot;shot_globals.do_sequence_mode is False, running Fifo mode now. Set to True for sequence mode&quot;</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing tweezers&quot;</span><span class="p">)</span>
        <span class="c1"># devices.dds0.synthesize(t+1e-2, shot_globals.TW_y_freqs, 0.95, 0)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">dds1</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">blue_456_detuning</span><span class="p">,</span>
            <span class="n">amp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">ph</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># for Sam&#39;s blue laser test</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_card</span><span class="p">()</span>
        <span class="c1"># has to be the first thing in the timing sequence (?)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="c1"># Turn on the tweezer</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># devices.tweezer_aom_analog.constant(t, 1) #0.3) #for single tweezer</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap</span><span class="p">:</span>
        <span class="n">turn_on_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># devices.dispenser_off_trigger.go_high(t)</span>
    <span class="n">do_MOT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">MOT_load_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_coil</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">MOT_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="c1"># _, ta_last_detuning, repump_last_detuning = load_molasses(t, ta_bm_detuning, repump_bm_detuning)</span>
    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>
    <span class="c1"># ta_last_detuning =  ta_bm_detuning</span>
    <span class="c1"># repump_last_detuning = repump_bm_detuning</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to full tweezer power</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_parity_projection_pulse</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_bm_detuning</span> <span class="o">=</span> <span class="n">parity_projection_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_pulse_dur</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="o">=</span><span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_robust_loading_pulse</span><span class="p">:</span>
        <span class="n">robust_loading_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_robust_loading_pulse_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_robust_loading_pulse_dur</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&#39;&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>

    <span class="c1"># first shot</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>  <span class="c1"># make sure shutter fully closed after 1st imaging</span>

    <span class="c1"># ta_last_detuning, repump_last_detuning = do_molasses(t, molasses_dur, close_shutter = True, use_img_beam = shot_globals.do_molasses_img_beam, use_mot_beam = shot_globals.do_molasses_mot_beam, ta_last_detuning=ta_last_detuning, repump_last_detuning= repump_last_detuning)</span>
    <span class="c1"># t += molasses_dur</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_modulation</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to full tweezer power</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">sine</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">20e-3</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>
            <span class="n">angfreq</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_modulation_freq</span><span class="p">,</span>  <span class="c1"># 0.5e6,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">dc_offset</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">0.4e6</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">20e-3</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to full tweezer power</span>

        <span class="c1"># devices.tweezer_aom_analog.ramp(</span>
        <span class="c1"># t,</span>
        <span class="c1"># duration=10e-3,</span>
        <span class="c1"># initial=shot_globals.tw_power,</span>
        <span class="c1"># final=1,</span>
        <span class="c1"># samplerate=4e5,</span>
        <span class="c1"># )  # ramp back to full tweezer power</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_456nm_laser</span><span class="p">:</span>
        <span class="n">blue_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">blue_456nm_duration</span>
        <span class="n">do_blue</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">blue_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">blue_dur</span>

    <span class="c1"># if shot_globals.</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>

    <span class="c1"># turn traps off for temperature measurement (release and recapture)</span>
    <span class="k">if</span> <span class="n">do_tw_trap_off</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp to loading tweezer power</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_turn_off_time</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># turn traps back on</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp to full tweezer power</span>

    <span class="c1"># second shot</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>  <span class="c1"># 100e-3</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>
    <span class="c1"># make sure tweezer AOM has full rf power</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1"># t += 1e-3</span>

        <span class="c1">##### dummy segment ######</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1"># t += 1e-3################</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_card</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_tweezer_check_fifo">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_tweezer_check_fifo">[docs]</a>
<span class="k">def</span> <span class="nf">do_tweezer_check_fifo</span><span class="p">():</span>
    <span class="n">MOT_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># 0.5</span>
    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">intensity_servo_keep_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># temporal for Sam&#39;s alignment</span>
    <span class="c1"># devices.moglabs_456_aom_digital.go_high(t)</span>
    <span class="c1"># devices.moglabs_456_aom_analog.constant(t, 1)</span>
    <span class="c1"># devices.octagon_456_aom_digital.go_high(t)</span>
    <span class="c1"># devices.octagon_456_aom_analog.constant(t, 1)</span>
    <span class="c1"># devices.blue_456_shutter.open(t)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
            <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_card</span><span class="p">()</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezer_card</span><span class="p">()</span>
            <span class="c1"># has to be the first thing in the timing sequence (?)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">dds0</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">TW_y_freqs</span><span class="p">,</span>
            <span class="n">amp</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
            <span class="n">ph</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># unit: MHz</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">dds1</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">blue_456_detuning</span><span class="p">,</span>
            <span class="n">amp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">ph</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># for Sam&#39;s blue laser test</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer x start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="c1"># Turn on the tweezer</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap</span><span class="p">:</span>
        <span class="n">turn_on_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">do_MOT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">MOT_load_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_coil</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">MOT_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="c1"># _, ta_last_detuning, repump_last_detuning = load_molasses(t, ta_bm_detuning, repump_bm_detuning)</span>
    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>
    <span class="c1"># ta_last_detuning =  ta_bm_detuning</span>
    <span class="c1"># repump_last_detuning = repump_bm_detuning</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to full tweezer power for imaging</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_parity_projection_pulse</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_bm_detuning</span> <span class="o">=</span> <span class="n">parity_projection_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_pulse_dur</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="o">=</span><span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_robust_loading_pulse</span><span class="p">:</span>
        <span class="n">robust_loading_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_robust_loading_pulse_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_robust_loading_pulse_dur</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>

    <span class="c1"># first shot</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># devices.digital_out_ch26.go_high(t) #for testing spectrum card output</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>  <span class="c1"># make sure sutter fully closed after 1st imaging</span>

    <span class="c1"># ta_last_detuning, repump_last_detuning = do_molasses(t, molasses_dur, close_shutter = True, use_img_beam = shot_globals.do_molasses_img_beam, use_mot_beam = shot_globals.do_molasses_mot_beam, ta_last_detuning=ta_last_detuning, repump_last_detuning= repump_last_detuning)</span>
    <span class="c1"># t += molasses_dur</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_modulation</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to full tweezer power</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">sine</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">20e-3</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>  <span class="c1"># 0.025,</span>
            <span class="n">angfreq</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">()</span> <span class="o">*</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_modulation_freq</span><span class="p">,</span>  <span class="c1"># 0.5e6,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">dc_offset</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">0.4e6</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">20e-3</span>

        <span class="c1"># lower trap after modulation</span>
        <span class="n">tw_power</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="c1"># devices.tweezer_aom_analog.constant(t, tw_power)</span>
        <span class="c1"># t += 1e-3</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">tw_power</span><span class="p">,</span>  <span class="c1"># shot_globals.tw_power,</span>
            <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># ramp back to full tweezer power</span>

        <span class="c1"># devices.tweezer_aom_analog.ramp(</span>
        <span class="c1"># t,</span>
        <span class="c1"># duration=10e-3,</span>
        <span class="c1"># initial=shot_globals.tw_power,</span>
        <span class="c1"># final=1,</span>
        <span class="c1"># samplerate=4e5,</span>
        <span class="c1"># )  # ramp back to full tweezer power</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_cooling_while_rearrange</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">93e-3</span>
        <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mf">7e-3</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="o">=</span><span class="n">repump_last_detuning</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>  <span class="c1"># molasses_dur</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">140e-3</span>

    <span class="c1"># t += 10e-3</span>

    <span class="c1"># turn traps off for temperature measurement (release and recapture)</span>
    <span class="k">if</span> <span class="n">do_tw_trap_off</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_turn_off_time</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># turn traps back on</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># second shot</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="c1"># devices.digital_out_ch26.go_low(t) #for testing spectrum card output</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-2</span>  <span class="c1"># 1e-3, need to  change to longer before turn off the tweezer since need to be &gt; 1 Notifiysize</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>
    <span class="c1"># make sure tweezer AOM has full rf power</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_rearrange_position_check</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_tweezer</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
            <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_time_offset</span> <span class="o">+</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_fine_time_offset</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="mf">50e-6</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="c1"># devices.tweezer_aom_digital.go_low(t)</span>
        <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="c1">##### dummy segment ######</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="c1">#################</span>
            <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_card</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span>
                <span class="n">t</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_time_offset</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span>
                <span class="n">t</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_time_offset</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezer_card</span><span class="p">()</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_optical_pump_in_tweezer_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_optical_pump_in_tweezer_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_optical_pump_in_tweezer_check</span><span class="p">():</span>

    <span class="n">MOT_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># 0.5</span>
    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">intensity_servo_keep_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_1_horizontal</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_1_h_position</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_1_vertical</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_1_v_position</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_2_horizontal</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_2_h_position</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">mirror_2_vertical</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_mirror_2_v_position</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
            <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_card</span><span class="p">()</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezer_card</span><span class="p">()</span>
            <span class="c1"># has to be the first thing in the timing sequence (?)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># devices.dds0.synthesize(t+1e-3, freq = TW_y_freqs, amp = 0.95, ph =</span>
        <span class="c1"># 0) # unit: MHz</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">dds1</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">blue_456_detuning</span><span class="p">,</span>
            <span class="n">amp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">ph</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># for Sam&#39;s blue laser test</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer x start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="c1"># Turn on the tweezer</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>

    <span class="c1"># the offset for the beging of output comparing to the trigger</span>
    <span class="n">spectrum_card_offset</span> <span class="o">=</span> <span class="mf">52.8e-6</span>
    <span class="n">spectrum_uwave_cable_atten</span> <span class="o">=</span> <span class="mf">4.4</span>  <span class="c1"># dB at 300 MHz</span>
    <span class="n">spectrum_uwave_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># -3 # dBm</span>
    <span class="n">uwave_clock</span> <span class="o">=</span> <span class="mf">9.192631770e3</span>  <span class="c1"># in unit of MHz</span>
    <span class="n">local_oscillator_freq_mhz</span> <span class="o">=</span> <span class="mi">9486</span>  <span class="c1"># in unit of MHz MKU LO 8-13 PLL setting</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">replay_mode</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
                                        <span class="n">channels</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;microwaves&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="n">spectrum_uwave_power</span> <span class="o">+</span> <span class="n">spectrum_uwave_cable_atten</span><span class="p">,</span>
                                                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                                   <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                                  <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;mmwaves&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span>
                                                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                                   <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span>
                                        <span class="n">clock_freq</span><span class="o">=</span><span class="mi">625</span><span class="p">,</span>
                                        <span class="n">use_ext_clock</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">ext_clock_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap</span><span class="p">:</span>
        <span class="n">turn_on_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">turn_off_dipole_trap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># temproral for Nolan&#39;s alignment</span>
    <span class="c1"># devices.ipg_1064_aom_digital.go_high(t)</span>
    <span class="c1"># devices.ipg_1064_aom_analog.constant(t, 1)</span>
    <span class="c1"># devices.pulse_1064_analog.constant(t,1)</span>
    <span class="c1"># devices.pulse_1064_digital.go_high(t)</span>
    <span class="c1"># devices.moglabs_456_aom_analog.constant(t,1)</span>
    <span class="c1"># devices.moglabs_456_aom_digital.go_high(t)</span>
    <span class="c1"># devices.blue_456_shutter.open(t)</span>
    <span class="c1"># devices.octagon_456_aom_analog.constant(t,0.5)</span>
    <span class="c1"># devices.octagon_456_aom_digital.go_high(t)</span>

    <span class="n">do_MOT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">MOT_load_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_coil</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">MOT_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="c1"># _, ta_last_detuning, repump_last_detuning = load_molasses(t, ta_bm_detuning, repump_bm_detuning)</span>
    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>
    <span class="c1"># ta_last_detuning =  ta_bm_detuning</span>
    <span class="c1"># repump_last_detuning = repump_bm_detuning</span>
    <span class="c1"># devices.mot_xy_shutter.close(t)</span>
    <span class="c1"># devices.mot_z_shutter.close(t)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
        <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># ramp back to full tweezer fpower for imaging</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_parity_projection_pulse</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_bm_detuning</span> <span class="o">=</span> <span class="n">parity_projection_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_pulse_dur</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="o">=</span><span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="o">=</span><span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_robust_loading_pulse</span><span class="p">:</span>
        <span class="n">robust_loading_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_robust_loading_pulse_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_robust_loading_pulse_dur</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>

    <span class="c1"># first shot</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># devices.digital_out_ch26.go_high(t) #for testing spectrum card output</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>  <span class="c1"># make sure sutter fully closed after 1st imaging</span>

    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">optical_pumping</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasx_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasy_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasz_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasz_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_456nm_laser</span><span class="p">:</span>
        <span class="n">blue_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">blue_456nm_duration</span>
        <span class="n">do_blue</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">blue_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">blue_dur</span>

    <span class="c1"># ================================================================================</span>
    <span class="c1"># Spectrum card related for microwaves</span>
    <span class="c1"># ================================================================================</span>
    <span class="k">if</span> <span class="n">do_tw_power_ramp</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">mw_sweep_duration</span> <span class="o">=</span> <span class="n">spectrum_microwave_sweep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">mw_sweep_duration</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">mw_sweep_duration</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">do_tw_trap_off</span><span class="p">:</span>  <span class="c1"># turn traps off during microwave</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># elif do_tw_lower_trap_during_mw: #lower trap depth during microwave</span>
        <span class="c1"># devices.tweezer_aom_analog.constant(t - tweezer_aom_thermal_time,</span>
        <span class="c1"># 0.05)#0.15)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">spectrum_card_offset</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">spectrum_card_offset</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="p">(</span>
                <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span>
                <span class="n">uwave_clock</span> <span class="o">-</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span><span class="p">)</span> <span class="o">*</span>
            <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&#39;Spectrum card freq = {</span>
        <span class="c1">#         local_oscillator_freq_mhz -</span>
        <span class="c1">#         uwave_clock -</span>
        <span class="c1">#         shot_globals.mw_detuning}&#39;)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span>

        <span class="k">if</span> <span class="n">do_tw_trap_off</span><span class="p">:</span>  <span class="c1"># turn traps back on</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># elif do_tw_lower_trap_during_mw: #turn trap back to full power</span>
        <span class="c1">#     devices.tweezer_aom_analog.constant(t,1)</span>

    <span class="k">if</span> <span class="n">do_tw_power_ramp</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># if shot_globals.tw_ramp_dur &lt; 7e-3:</span>
        <span class="c1">#     t += 7e-3 - shot_globals.tw_ramp_dur</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>  <span class="c1"># 10e-3 #for shutter to close and open after optical pump before killing pulse</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
        <span class="c1"># for shutter and vco to be ready for killing pulse</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span> <span class="o">+</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span>

        <span class="c1"># tw power ramp</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># devices,tweezer_aom_analog.constant(t, 0.15)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">killing_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-3</span>  <span class="c1"># 10e-3</span>

        <span class="c1"># tw power ramp</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

    <span class="c1"># for testing only</span>
    <span class="c1"># devices.tweezer_aom_digital.go_low(t)</span>
    <span class="c1"># devices.tweezer_aom_analog.constant(t,0)</span>
    <span class="c1"># t += shot_globals.op_killing_pulse_time</span>
    <span class="c1"># devices.tweezer_aom_digital.go_high(t)</span>
    <span class="c1"># devices.tweezer_aom_analog.constant(t,shot_globals.tw_power)</span>
    <span class="c1"># t += 10e-3</span>
    <span class="c1"># devices.tweezer_aom_analog.constant(t,1)</span>

    <span class="c1"># t += 10e-3</span>

    <span class="c1"># second shot</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

    <span class="c1"># devices.digital_out_ch26.go_low(t) #for testing spectrum card output</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-2</span>  <span class="c1"># 1e-3, need to  change to longer before turn off the tweezer since need to be &gt; 1 Notifiysize</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>
    <span class="c1"># make sure tweezer AOM has full rf power</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_rearrange_position_check</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_tweezer</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
            <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_time_offset</span> <span class="o">+</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_fine_time_offset</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="mf">50e-6</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
        <span class="c1">##### dummy segment ######</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># dummy segment</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="c1"># devices.tweezer_aom_digital.go_low(t)</span>
        <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="c1">##### dummy segment ######</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="c1">#################</span>
            <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_card</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span>
                <span class="n">t</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_time_offset</span><span class="p">)</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">digital_out_ch22</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span>
                <span class="n">t</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_time_offset</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezer_card</span><span class="p">()</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_optical_pump_in_microtrap_check">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.do_optical_pump_in_microtrap_check">[docs]</a>
<span class="k">def</span> <span class="nf">do_optical_pump_in_microtrap_check</span><span class="p">():</span>
    <span class="n">MOT_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># 0.5</span>
    <span class="n">molasses_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span>

    <span class="n">intensity_servo_keep_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_card</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezer_card</span><span class="p">()</span>
        <span class="c1"># has to be the first thing in the timing sequence (?)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">dds0</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span>
        <span class="n">t</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="n">TW_y_freqs</span><span class="p">,</span>
        <span class="n">amp</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="n">ph</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># unit: MHz</span>
    <span class="c1"># devices.dds1.synthesize(t+1e-3, freq = shot_globals.blue_456_detuning, amp = 0.95, ph = 0)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer x start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="c1"># Turn on the tweezer</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 0.3) #for single tweezer</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># for aligning local addressing beams</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># the offset for the beging of output comparing to the trigger</span>
    <span class="n">spectrum_card_offset</span> <span class="o">=</span> <span class="mf">52.8e-6</span>
    <span class="n">spectrum_uwave_cable_atten</span> <span class="o">=</span> <span class="mf">4.4</span>  <span class="c1"># dB at 300 MHz</span>
    <span class="n">spectrum_uwave_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># -3 # dBm</span>
    <span class="n">uwave_clock</span> <span class="o">=</span> <span class="mf">9.192631770e3</span>  <span class="c1"># in unit of MHz</span>
    <span class="n">local_oscillator_freq_mhz</span> <span class="o">=</span> <span class="mi">9486</span>  <span class="c1"># in unit of MHz MKU LO 8-13 PLL setting</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">replay_mode</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
                                        <span class="n">channels</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;microwaves&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="n">spectrum_uwave_power</span> <span class="o">+</span> <span class="n">spectrum_uwave_cable_atten</span><span class="p">,</span>
                                                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                                   <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                                  <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;mmwaves&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span>
                                                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="s1">&#39;is_amplified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="s1">&#39;amplifier&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;calibration_power&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                                   <span class="s1">&#39;power_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;constant_total&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;max_pulses&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span>
                                        <span class="n">clock_freq</span><span class="o">=</span><span class="mi">625</span><span class="p">,</span>
                                        <span class="n">use_ext_clock</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">ext_clock_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">do_MOT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">MOT_load_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_coil</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">MOT_load_dur</span>  <span class="c1"># how long MOT last</span>

    <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_molasses</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">molasses_dur</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">molasses_dur</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">optical_pumping</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">x_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasx_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasx_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">y_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasy_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasy_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">z_coil_current</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">biasz_calib</span><span class="p">(</span>
        <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasz_field</span><span class="p">))</span>   <span class="c1"># define quantization axis</span>
    <span class="c1"># ================================================================================</span>
    <span class="c1"># Spectrum card related for microwaves</span>
    <span class="c1"># ================================================================================</span>
    <span class="k">if</span> <span class="n">do_local_addr_ramp</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">mw_sweep_duration</span> <span class="o">=</span> <span class="n">spectrum_microwave_sweep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">mw_sweep_duration</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">mw_sweep_duration</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">spectrum_card_offset</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_high</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">spectrum_card_offset</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="p">(</span>
                <span class="n">local_oscillator_freq_mhz</span> <span class="o">-</span>
                <span class="n">uwave_clock</span> <span class="o">-</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span><span class="p">)</span> <span class="o">*</span>
            <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&#39;Spectrum card freq = {</span>
        <span class="c1">#         local_oscillator_freq_mhz -</span>
        <span class="c1">#         uwave_clock -</span>
        <span class="c1">#         shot_globals.mw_detuning}&#39;)</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">uwave_absorp_switch</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 10e-3 #for shutter to close and open after optical pump before</span>
        <span class="c1"># killing pulse</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span>

    <span class="k">if</span> <span class="n">do_local_addr_ramp</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
        <span class="c1"># tw power ramp</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_power</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># for shutter and vco to be ready for killing pulse</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">CONST_TA_VCO_RAMP_TIME</span> <span class="o">+</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">killing_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
        <span class="c1"># t += 1e-3</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_analog</span><span class="o">.</span><span class="n">ramp</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_dur</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">local_addr_ramp_power</span><span class="p">,</span>
            <span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">samplerate</span><span class="o">=</span><span class="mf">4e5</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">,</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>

    <span class="c1"># first shot</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>  <span class="c1"># make sure sutter fully closed after 1st imaging</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>

    <span class="c1"># second shot</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">pre_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

    <span class="c1"># devices.digital_out_ch26.go_low(t) #for testing spectrum card output</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span> <span class="o">=</span> <span class="n">do_imaging</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">,</span> <span class="n">repump_last_detuning</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-2</span>  <span class="c1"># 1e-3, need to  change to longer before turn off the tweezer since need to be &gt; 1 Notifiysize</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ta_last_detuning</span><span class="p">)</span>
    <span class="c1"># make sure tweezer AOM has full rf power</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_rearrange_position_check</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">manta419b_tweezer</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span>
            <span class="s1">&#39;manta419b&#39;</span><span class="p">,</span>
            <span class="n">t</span> <span class="o">-</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_time_offset</span> <span class="o">+</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">TW_rearrangement_fine_time_offset</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="mf">50e-6</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># if shot_globals.do_mw_pulse or shot_globals.do_mw_sweep:</span>
    <span class="c1">#     ##### dummy segment ####</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">single_freq</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
        <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># dummy segment</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">spectrum_uwave</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">spcm_sequence_mode</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1">##### dummy segment ######</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">start_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer start time:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="c1">#################</span>
        <span class="n">spectrum_manager</span><span class="o">.</span><span class="n">stop_card</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">spectrum_manager_fifo</span><span class="o">.</span><span class="n">stop_tweezer_card</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tweezer stop time:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">tweezer_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_local_addr</span><span class="p">:</span>
        <span class="c1"># stop tweezers</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">local_addr_1064_aom_digital</span><span class="o">.</span><span class="n">go_low</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Insert &quot;stay on&quot; statements for alignment here...</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_in_situ_check</span><span class="p">:</span>
        <span class="c1">#t = do_mot_in_situ_check(t)</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">do_mot_in_situ_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_tof_check</span><span class="p">:</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">do_mot_tof_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_in_situ_check</span><span class="p">:</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">do_molasses_in_situ_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_tof_check</span><span class="p">:</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">do_molasses_tof_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_field_calib_in_molasses_check</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_field_calib_in_molasses_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap_tof_check</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_dipole_trap_tof_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_img_beam_alignment_check</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_img_beam_alignment_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_position_check</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_tweezer_position_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_check</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_tweezer_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_check_fifo</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_tweezer_check_fifo</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_optical_pump_in_tweezer_check</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_optical_pump_in_tweezer_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_optical_pump_in_microtrap_check</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">do_optical_pump_in_microtrap_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Michelle Wu, Lin Xin, Nolan Peard, Sam Cohen, Tony Zhang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>