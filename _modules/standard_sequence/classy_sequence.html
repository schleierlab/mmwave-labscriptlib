

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>standard_sequence.classy_sequence &mdash; mmwave-labscript  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            mmwave-labscript
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mmwave-labscript</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">standard_sequence.classy_sequence</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for standard_sequence.classy_sequence</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;X:\userlib\labscriptlib&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="k">if</span> <span class="n">root_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">labscript</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">connection_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">devices</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">labscriptlib.shot_globals</span><span class="w"> </span><span class="kn">import</span> <span class="n">shot_globals</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">labscriptlib.standard_sequence.experiment_components</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BField</span><span class="p">,</span>
    <span class="n">Camera</span><span class="p">,</span>
    <span class="n">D2Lasers</span><span class="p">,</span>
    <span class="n">Microwave</span><span class="p">,</span>
    <span class="n">RydLasers</span><span class="p">,</span>
    <span class="n">ShutterConfig</span><span class="p">,</span>
    <span class="n">TweezerLaser</span><span class="p">,</span>
    <span class="n">UVLamps</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">spcm_sequence_mode</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_sequence_mode</span>

<span class="c1"># TODO is this necessary?</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">devices</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>


<span class="c1"># fixed parameters in the script</span>
<span class="n">CONST_TA_PUMPING_DETUNING</span> <span class="o">=</span> <span class="o">-</span><span class="mi">251</span>  <span class="c1"># MHz 4-&gt;4 tansition</span>
<span class="n">CONST_REPUMP_DEPUMPING_DETUNING</span> <span class="o">=</span> <span class="o">-</span><span class="mf">201.24</span>  <span class="c1"># MHz 3-&gt;3 transition</span>


<span class="c1"># lasers_852 =  D2Lasers()</span>
<span class="c1"># lasers_852.pulse_imaging(t=300e-6, duration=100e-6)</span>
<span class="c1"># lasers_852.pulse_ta(t=450e-6, duration=100e-6, hold_shutter_open = True)</span>
<span class="c1"># pulser_ta(t=600e-6, duration=100e-6)</span>


<span class="c1"># MOTconfig = {shutter1: True, shutter2: False, shutter3: True}</span>
<span class="c1"># imagconfig = {shutter1: False, shutter2: True, }</span>


<span class="c1"># Sequence Classes</span>
<span class="c1"># -------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="MOTSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MOTSequence</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequence for Magneto-Optical Trap (MOT) operations.</span>

<span class="sd">    This class manages the sequence of operations related to MOT loading, imaging,</span>
<span class="sd">    and manipulation. It coordinates multiple hardware components including D2 lasers,</span>
<span class="sd">    magnetic fields, microwave systems, UV lamps, and cameras.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Standard initialization for hardware objects puts everything in</span>
        <span class="c1"># correct state/tuning to start loading the MOT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span> <span class="o">=</span> <span class="n">D2Lasers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span> <span class="o">=</span> <span class="n">BField</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span> <span class="o">=</span> <span class="n">Microwave</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UVLamps_obj</span> <span class="o">=</span> <span class="n">UVLamps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<div class="viewcode-block" id="MOTSequence.do_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_mot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_mot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute MOT loading sequence.</span>

<span class="sd">        Performs a complete MOT loading sequence, including optional UV enhancement</span>
<span class="sd">        and proper timing coordination between different components.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for MOT sequence</span>
<span class="sd">            dur (float): Duration of MOT loading</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the MOT sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_do_uv</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UVLamps_obj</span><span class="o">.</span><span class="n">uv_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_uv_duration</span><span class="p">)</span>
            <span class="c1"># the uv duration should be determined for each dispenser current</span>
            <span class="c1"># generally, get superior loading in the 10s of milliseconds</span>

        <span class="c1"># if using a long UV duration, want to make sure that the MOT doesn&#39;t finish</span>
        <span class="c1"># loading leaving the UV is still on for imaging.</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_uv_duration</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">dur</span><span class="p">,</span>
            <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_FULL</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.reset_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.reset_mot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_mot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset MOT parameters to default values.</span>

<span class="sd">        Resets magnetic fields, laser frequencies, and other MOT parameters to their</span>
<span class="sd">        default values for MOT operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Time to begin reset</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the reset sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># B fields</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">mot_bias_voltages</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_x_coil_voltage</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_y_coil_voltage</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_z_coil_voltage</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">voltage_vector</span><span class="o">=</span><span class="n">mot_bias_voltages</span><span class="p">)</span>

        <span class="c1"># Reset laser frequency and configuration</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_freq</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_on</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.image_mot">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.image_mot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">image_mot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Capture an image of the MOT.</span>

<span class="sd">        Configures imaging parameters and captures an image of the MOT using the</span>
<span class="sd">        camera system.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Time to begin imaging</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after imaging</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the imaging sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Move to on resonance, make sure AOM is off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span>

        <span class="c1"># Make sure coils are off</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="s2">&quot;MOT_manta&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_exposure_time</span><span class="p">)</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_exposure_time</span><span class="p">,</span>
            <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_FULL</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_ta_power</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_repump_power</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_do_mot_in_situ_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform in-situ MOT loading and imaging sequence.</span>

<span class="sd">        This standalone sequence loads a MOT and images it in-situ, optionally</span>
<span class="sd">        including a background image and MOT reset.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for sequence</span>
<span class="sd">            reset_mot (bool, optional): Whether to reset MOT parameters after sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running _do_mot_in_situ_sequence&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MOT coils = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">)</span>
        <span class="c1"># MOT loading time 500 ms</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Shutter does not need to be held open</span>

        <span class="c1"># Wait until the MOT disappear for background image</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Reset laser frequency so lasers do not jump frequency and come unlocked</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_freq</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="c1"># TODO: Needs more experimental debugging. When should the shutter close? What timescales should we expect the MOT to disperse in?</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_do_mot_tof_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform time-of-flight MOT imaging sequence.</span>

<span class="sd">        This sequence loads a MOT, releases it, and images after a time-of-flight</span>
<span class="sd">        period to measure temperature or expansion.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for sequence</span>
<span class="sd">            reset_mot (bool, optional): Whether to reset MOT parameters after sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running _do_mot_tof_sequence&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MOT coils = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">)</span>
        <span class="c1"># MOT loading time 500 ms</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>

        <span class="c1"># assert shot_globals.mot_tof_imaging_delay &gt; CONST_MIN_SHUTTER_OFF_TIME, &quot;time of flight too short for shutter&quot;</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mot_tof_imaging_delay</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Shutter does not need to be held open</span>

        <span class="c1"># Wait until the MOT disappear for background image</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Reset laser frequency so lasers do not jump frequency and come unlocked</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">reset_to_mot_freq</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

<div class="viewcode-block" id="MOTSequence.ramp_to_molasses">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.ramp_to_molasses">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ramp_to_molasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure system for optical molasses.</span>

<span class="sd">        Ramps laser detunings and turns off magnetic fields to transition from</span>
<span class="sd">        MOT to optical molasses configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Time to begin transition</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the transition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># detuning is ramped slowly here (duration = 1e-3) because atoms</span>
        <span class="c1"># see the light during the frequency ramp.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_detuning</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="MOTSequence.do_molasses">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_molasses">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_molasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute optical molasses cooling sequence.</span>

<span class="sd">        Performs optical molasses cooling with specified parameters and beam</span>
<span class="sd">        configurations.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for molasses</span>
<span class="sd">            dur (float): Duration of molasses cooling</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close shutters after sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the molasses sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_img_beam</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_mot_beam</span>
        <span class="p">),</span> <span class="s2">&quot;either do_molasses_img_beam or do_molasses_mot_beam has to be on&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_detuning</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">&quot;bright molasses detuning = 0. TA detuning should be non-zero for bright molasses.&quot;</span>
        <span class="c1"># print(f&quot;molasses detuning is {shot_globals.bm_ta_detuning}&quot;)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ramp_to_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_mot_beam</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">dur</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_FULL</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_power</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_power</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_img_beam</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">dur</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">IMG_FULL</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_ta_power</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_repump_power</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span></div>


    <span class="c1"># Which arguments are actually necessary to pass or even set as a defualt?</span>
    <span class="c1"># How many of them can just be set to globals?</span>
    <span class="c1"># TODO: Maybe pass the shutter config into here? This would get rid of all the if statements?</span>
<div class="viewcode-block" id="MOTSequence.do_molasses_dipole_trap_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.MOTSequence.do_molasses_dipole_trap_imaging">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">ta_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">ta_detuning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">exposure_time</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_exposure_time</span><span class="p">,</span>
        <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Capture an image of the molasses or the dipole trap.</span>

<span class="sd">        Configures imaging parameters and captures an image of the molasses or the</span>
<span class="sd">        dipole trap using the camera system.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Time to begin imaging</span>
<span class="sd">            ta_power (float, optional): Power of the TA beam</span>
<span class="sd">            repump_power (float, optional): Power of the repump beam</span>
<span class="sd">            exposure (float, optional): Exposure time of the camera</span>
<span class="sd">            do_repump (bool, optional): Whether to use the repump beam</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after imaging</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the imaging sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># zero the field</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Ramp to imaging frequencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">ta_detuning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span>

        <span class="n">shutter_config</span> <span class="o">=</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">select_imaging_shutters</span><span class="p">(</span><span class="n">do_repump</span><span class="o">=</span><span class="n">do_repump</span><span class="p">)</span>

        <span class="c1"># full power ta and repump pulse</span>
        <span class="n">t_pulse_end</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="p">,</span>
            <span class="n">shutter_config</span><span class="p">,</span>
            <span class="n">ta_power</span><span class="p">,</span>
            <span class="n">repump_power</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># TODO: ask Lin and Michelle and max() logic and if we always want it there</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">camera_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MOT_manta&quot;</span> <span class="ow">or</span> <span class="s2">&quot;tweezer_manta&quot;</span><span class="p">:</span>
            <span class="n">exposure_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">,</span> <span class="mf">50e-6</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;kinetix&quot;</span><span class="p">:</span>
            <span class="n">exposure_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Camera type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> not recognized&quot;</span><span class="p">)</span>

        <span class="c1"># expose the camera</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">t_aom_start</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">)</span>

        <span class="c1"># Closes the aom and the specified shutters</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">exposure_time</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_pulse_end</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_do_molasses_in_situ_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform in-situ molasses loading and imaging sequence.</span>

<span class="sd">        This standalone sequence loads a molasses and images it in-situ, optionally</span>
<span class="sd">        including a background image and MOT reset.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for sequence</span>
<span class="sd">            reset_mot (bool, optional): Whether to reset MOT parameters after sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># MOT loading time 500 ms</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Turn off MOT for taking background images</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>

        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_molasses_tof_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform time-of-flight molasses imaging sequence.</span>

<span class="sd">        This sequence loads a molasses, releases it, and images after a time-of-flight</span>
<span class="sd">        period to measure temperature or expansion.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for sequence</span>
<span class="sd">            reset_mot (bool, optional): Whether to reset MOT parameters after sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_MIN_SHUTTER_OFF_TIME</span>
        <span class="p">),</span> <span class="s2">&quot;time of flight too short for shutter&quot;</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_tof_imaging_delay</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Turn off MOT for taking background images</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>



<div class="viewcode-block" id="OpticalPumpingSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.OpticalPumpingSequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpticalPumpingSequence</span><span class="p">(</span><span class="n">MOTSequence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequence for optical pumping operations.</span>

<span class="sd">    This class manages sequences related to optical pumping of atoms between different</span>
<span class="sd">    hyperfine states (F=3 and F=4) of the Cs ground state (6S) using either MOT beams or sigma-polarized light.</span>
<span class="sd">    It inherits from MOTSequence and adds specialized optical pumping capabilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the optical pumping sequence.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Initial time for the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpticalPumpingSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<div class="viewcode-block" id="OpticalPumpingSequence.pump_to_F4">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.OpticalPumpingSequence.pump_to_F4">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pump_to_F4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pump atoms from F=3 to F=4 hyperfine state.</span>

<span class="sd">        Uses either MOT beams or sigma-polarized light to pump atoms from the F=3</span>
<span class="sd">        to F=4 ground state. The method configures the appropriate magnetic fields,</span>
<span class="sd">        laser frequencies, and timing sequences based on the chosen pumping method.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the pumping sequence</span>
<span class="sd">            label (str): Pumping method to use (&#39;mot&#39; or &#39;sigma&#39;)</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after</span>
<span class="sd">                the sequence. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, float]: End time of sequence and AOM turn-off time</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If an unsupported pumping method is specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># op_biasx_field, op_biasy_field, op_biasz_field = (</span>
        <span class="c1">#         self.BField_obj.convert_bias_fields_sph_to_cart(</span>
        <span class="c1">#             shot_globals.op_bias_amp,</span>
        <span class="c1">#             shot_globals.op_bias_phi,</span>
        <span class="c1">#             shot_globals.op_bias_theta,</span>
        <span class="c1">#         )</span>
        <span class="c1">#     )</span>

        <span class="c1"># Change the field orientation to be the same way as Adam Kaufman&#39;s thesis,</span>
        <span class="c1"># which is the major qunatization axis x always fixed to 2.8G</span>
        <span class="c1"># while we vary the angle and amplitude of an added-on field</span>

        <span class="n">op_biasx_field</span><span class="p">,</span> <span class="n">op_biasy_field</span><span class="p">,</span> <span class="n">op_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                    <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_added_amp</span><span class="p">,</span>
                    <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_phi</span><span class="p">,</span>
                    <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_theta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">op_biasx_field</span> <span class="o">=</span> <span class="n">op_biasx_field</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_bias_amp</span>



        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;mot&quot;</span><span class="p">:</span>
            <span class="c1"># Use the MOT beams for optical pumping</span>
            <span class="c1"># Do a repump pulse</span>
            <span class="c1"># print(&quot;I&#39;m using mot beams for optical pumping&quot;)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">op_biasx_field</span><span class="p">,</span> <span class="n">op_biasy_field</span><span class="p">,</span> <span class="n">op_biasz_field</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_MOT_op_time</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_REPUMP</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">t_aom_off</span> <span class="o">=</span> <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_MOT_op_time</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span>

        <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span>
            <span class="c1"># Use the sigma+ beam for optical pumping</span>

            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">op_biasx_field</span><span class="p">,</span> <span class="n">op_biasy_field</span><span class="p">,</span> <span class="n">op_biasz_field</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># ramp detuning to 4 -&gt; 4, 3 -&gt; 4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_pumping_detuning</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_pumping_detuning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Do a sigma+ pulse</span>
            <span class="c1"># TODO: is shot_globals.op_ramp_delay just extra fudge time? can it be eliminated?</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ramp_delay</span><span class="p">)</span>

            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_FULL</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_power</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_power</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">t_aom_off</span> <span class="o">=</span> <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>

            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span> <span class="o">&lt;</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>
            <span class="p">),</span> <span class="s2">&quot;TA time should be shorter than repump for pumping to F=4&quot;</span>
            <span class="c1"># TODO: test this timing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ta_aom_off</span><span class="p">(</span><span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
                <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span><span class="p">,</span>
                <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
                <span class="n">CONST_TA_PUMPING_DETUNING</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># move the detuning to -125 MHz relative to 4-&gt;5 transtion to avoid the leakage light on 4-&gt;4 transition doing depump, half way between 4-&gt;5 and 4-&gt;4</span>
            <span class="p">)</span>
            <span class="c1"># Close the shutters</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_time</span> <span class="o">+</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">])</span><span class="c1">#+= 1e-3</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This optical pumping method is not implemented&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpticalPumpingSequence.depump_ta_pulse">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.OpticalPumpingSequence.depump_ta_pulse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">depump_ta_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a TA pulse to depump atoms from F=4 to F=3.</span>

<span class="sd">        Performs a standalone TA pulse for depumping atoms from F=4 to F=3. This method</span>
<span class="sd">        is used to determine minimum time offsets between repump and TA when doing</span>
<span class="sd">        depump_to_F3, and for dark state measurements.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the depumping pulse</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after</span>
<span class="sd">                the sequence. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the depumping sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_depump_ta_detuning</span> <span class="c1">#CONST_TA_PUMPING_DETUNING</span>
        <span class="p">)</span>
        <span class="c1"># t += max(D2Lasers.CONST_TA_VCO_RAMP_TIME, shot_globals.op_ramp_delay)</span>

        <span class="c1"># The shutter configuration needs to be optical_pumping_full</span>
        <span class="c1"># to make sure no shutter switch from the depump_to_F3/pump_to_F4</span>
        <span class="c1"># sequence, this allow the two pulse sequence purely switched</span>
        <span class="c1"># with aom so that they are next to each other</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_depump_pulse_time</span><span class="p">,</span>
            <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_TA</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_depump_power</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
            <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_depump_pulse_time</span><span class="p">,</span>
            <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span>
            <span class="n">CONST_TA_PUMPING_DETUNING</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># move the detuning to -125 MHz relative to 4-&gt;5 transtion to avoid the leakage light on 4-&gt;4 transition doing depump, half way between 4-&gt;5 and 4-&gt;4</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_depump_pulse_time</span> <span class="o">+</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">])</span><span class="c1">#+= 1e-3</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="OpticalPumpingSequence.depump_to_F3">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.OpticalPumpingSequence.depump_to_F3">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">depump_to_F3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pump atoms from F=4 to F=3 hyperfine state.</span>

<span class="sd">        Uses either MOT beams or sigma-polarized light to pump atoms from the F=4</span>
<span class="sd">        to F=3 ground state. Similar to pump_to_F4 but optimized for depumping</span>
<span class="sd">        to minimize parameter complexity.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the depumping sequence</span>
<span class="sd">            label (str): Depumping method to use (&#39;mot&#39; or &#39;sigma&#39;)</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after</span>
<span class="sd">                the sequence. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, float]: End time of sequence and AOM turn-off time</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If an unsupported depumping method is specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">mot_coils_on</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">switch_mot_coils</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;mot&quot;</span><span class="p">:</span>
            <span class="c1"># Use the MOT beams for optical depumping</span>
            <span class="c1"># ramp detuning to 4 -&gt; 4 for TA</span>
            <span class="c1"># print(&quot;I&#39;m using mot beams for depumping&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">CONST_TA_PUMPING_DETUNING</span>
            <span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span>
            <span class="c1"># Do a TA pulse</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_MOT_odp_time</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">MOT_TA</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">t_aom_off</span> <span class="o">=</span> <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_MOT_op_time</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span>

        <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span>
            <span class="c1"># Use the sigma+ beam for optical pumping</span>
            <span class="n">op_biasx_field</span><span class="p">,</span> <span class="n">op_biasy_field</span><span class="p">,</span> <span class="n">op_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">get_op_bias_fields</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">op_biasx_field</span><span class="p">,</span> <span class="n">op_biasy_field</span><span class="p">,</span> <span class="n">op_biasz_field</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># ramp detuning to 4 -&gt; 4, 3 -&gt; 4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ta_pumping_detuning</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># 3-&gt; 3</span>
            <span class="c1"># self.D2Lasers_obj.ramp_repump_freq(t, D2Lasers.CONST_TA_VCO_RAMP_TIME, CONST_REPUMP_DEPUMPING_DETUNING)</span>
            <span class="c1"># Do a sigma+ pulse</span>
            <span class="c1"># TODO: is shot_globals.op_ramp_delay just extra fudge time? can it be eliminated?</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_ramp_delay</span><span class="p">)</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_FULL</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_power</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_power</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">t_aom_off</span> <span class="o">=</span> <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span>

            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_ta_time</span> <span class="o">&gt;</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_time</span>
            <span class="p">),</span> <span class="s2">&quot;TA time should be longer than repump for depumping to F = 3&quot;</span>
            <span class="c1"># TODO: test this timing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">repump_aom_off</span><span class="p">(</span><span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">odp_repump_time</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This optical depumping method is not implemented&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="OpticalPumpingSequence.kill_F4">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.OpticalPumpingSequence.kill_F4">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kill_F4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove atoms in the F=4 hyperfine state using resonant light.</span>

<span class="sd">        Uses a resonant TA pulse to push away atoms in the F=4 state while leaving</span>
<span class="sd">        F=3 atoms unaffected. The method configures the appropriate shutter and</span>
<span class="sd">        laser parameters for efficient state-selective removal.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the removal sequence</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after</span>
<span class="sd">                the sequence. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, float]: End time of sequence and AOM turn-off time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The shutter configuration can be optical_pumping_full or optical_pump_TA</span>
        <span class="c1"># optical_pumping_full allow the two pulse sequence purely switched with aom after</span>
        <span class="c1"># pump_to_F4 / depump_to_F3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">shutter_config</span> <span class="o">==</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_FULL</span><span class="p">:</span>
            <span class="n">shutter_config</span> <span class="o">=</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_FULL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutter_config</span> <span class="o">=</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_TA</span>

        <span class="c1"># tune to resonance</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">killing_pulse_detuning</span>
        <span class="p">)</span>
        <span class="c1"># do a ta pulse via optical pumping path</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span><span class="p">,</span>
            <span class="n">shutter_config</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_ta_power</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">t_aom_off</span> <span class="o">=</span> <span class="n">t_aom_start</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>

        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span></div>


<div class="viewcode-block" id="OpticalPumpingSequence.kill_F3">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.OpticalPumpingSequence.kill_F3">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kill_F3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove atoms in the F=3 hyperfine state.</span>

<span class="sd">        This method is not yet implemented but will provide functionality to</span>
<span class="sd">        selectively remove atoms in the F=3 state.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the removal sequence</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: This method is not yet implemented</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_optical_pump_molasses_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a complete optical pumping sequence in molasses.</span>

<span class="sd">        Performs a sequence of: MOT loading, molasses cooling, optical pumping to F=4,</span>
<span class="sd">        and imaging. Optionally includes background imaging and MOT reset.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>
<span class="sd">            reset_mot (bool, optional): Whether to reset MOT parameters after sequence.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># MOT loading time 500 ms</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Turn off MOT for taking background images</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>

        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_pump_debug_in_molasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Debug optical pumping sequence in molasses.</span>

<span class="sd">        Executes a comprehensive debug sequence for optical pumping, including options</span>
<span class="sd">        for depumping, pumping, dark state measurements, and microwave transitions.</span>
<span class="sd">        The sequence can be configured through shot_globals parameters for:</span>
<span class="sd">        - Depumping to F=3</span>
<span class="sd">        - Optical pumping to F=4</span>
<span class="sd">        - Dark state lifetime measurements</span>
<span class="sd">        - Microwave transitions</span>
<span class="sd">        - State-selective removal</span>
<span class="sd">        - Imaging with variable parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>
<span class="sd">            reset_mot (bool, optional): Whether to reset MOT parameters after sequence.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dp</span><span class="p">:</span>
            <span class="c1"># do optical depumping to F=3</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_to_F3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_op</span><span class="p">:</span>
            <span class="c1"># do optical pumping to F=4</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">t_aom_off</span> <span class="o">+=</span> <span class="mf">50e-6</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_depump_ta_pulse_after_pump</span><span class="p">:</span>
            <span class="c1"># do depump pulse to meausre the dark state lifetime</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_ta_pulse</span><span class="p">(</span><span class="n">t_aom_off</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="c1"># do kill pulse to remove all atom in F=4</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span><span class="n">t_aom_off</span><span class="p">)</span>
        <span class="n">t_depump</span> <span class="o">=</span> <span class="n">t</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasx_field</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasy_field</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_biasz_field</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
            <span class="c1"># do microwave in molasses</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="c1"># do kill pulse after microwave to remove F=4 atom</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span><span class="n">t_aom_off</span><span class="p">)</span>

        <span class="c1"># postpone next sequence until shutter off time reached</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_depump</span> <span class="o">+</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_MIN_SHUTTER_OFF_TIME</span><span class="p">)</span>

        <span class="c1"># This is the only place required for the special value of imaging</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">ta_power</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">do_repump</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_imaging_do_repump</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Turn off MOT for taking background images</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">ta_power</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">do_repump</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_imaging_do_repump</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">reset_spectrum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_F4_microwave_spec_molasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Measure microwave transitions with atoms initially in F=4.</span>

<span class="sd">        Performs a sequence to measure microwave transitions starting with atoms in F=4:</span>
<span class="sd">        1. Load MOT and cool to molasses</span>
<span class="sd">        2. Optically pump atoms to F=4</span>
<span class="sd">        3. Apply microwave pulse or frequency sweep</span>
<span class="sd">        4. Selectively remove F=4 atoms</span>
<span class="sd">        5. Image remaining atoms</span>

<span class="sd">        The sequence operates in molasses conditions for better control and can be</span>
<span class="sd">        configured for either fixed-frequency pulses or frequency sweeps through</span>
<span class="sd">        shot_globals parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>
<span class="sd">            reset_mot (bool, optional): Whether to reset MOT parameters after sequence.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mot_load_dur</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mot_load_dur</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># [mw_biasx_field, mw_biasy_field, mw_biasz_field] = [</span>
            <span class="c1">#     shot_globals.mw_biasx_field,</span>
            <span class="c1">#     shot_globals.mw_biasy_field,</span>
            <span class="c1">#     shot_globals.mw_biasz_field,</span>
            <span class="c1"># ]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
                <span class="n">t_aom_off</span> <span class="o">+</span> <span class="mf">200e-6</span><span class="p">,</span> <span class="c1">#TODO: wait for 200e-6s extra time in optical pumping field, can be changed</span>
                <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">CONST_COIL_OFF_TIME</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
            <span class="n">mw_sweep_start</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">mw_sweep_end</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_sweep</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">mw_sweep_start</span><span class="p">,</span> <span class="n">mw_sweep_end</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_duration</span>
            <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-6</span> <span class="c1">#TODO: wait for extra time before killing, can be changed</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># This is the only place required for the special value of imaging</span>
        <span class="c1"># t += 1e-3 # TODO: from the photodetector, the optical pumping beam shutter seems to be closing slower than others</span>
        <span class="c1"># that&#39;s why we add extra time here before imaging to prevent light leakage from optical pump beam</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">ta_power</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Turn off MOT for taking background images</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-1</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">ta_power</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">repump_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="mf">10e-3</span><span class="p">,</span>
            <span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-2</span>
        <span class="k">if</span> <span class="n">reset_mot</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>



<div class="viewcode-block" id="TweezerSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TweezerSequence</span><span class="p">(</span><span class="n">OpticalPumpingSequence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequence for optical tweezer operations.</span>

<span class="sd">    This class manages sequences related to loading, manipulating, and imaging atoms</span>
<span class="sd">    in optical tweezers. It inherits from OpticalPumpingSequence to combine optical</span>
<span class="sd">    pumping capabilities with tweezer operations. The class coordinates multiple</span>
<span class="sd">    hardware components including tweezer lasers, imaging systems, and atom manipulation</span>
<span class="sd">    tools.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the tweezer sequence.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Initial time for the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TweezerSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span> <span class="o">=</span> <span class="n">TweezerLaser</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<div class="viewcode-block" id="TweezerSequence.ramp_to_imaging_parameters">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence.ramp_to_imaging_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ramp_to_imaging_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure laser parameters for imaging or additional cooling.</span>

<span class="sd">        Ramps the laser detunings and powers to values optimized for imaging.</span>
<span class="sd">        Also used for additional cooling of atoms in tweezers. Sets bias fields</span>
<span class="sd">        to zero and configures both TA and repump frequencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for parameter ramping</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the ramping sequence</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If imaging TA or repump powers are set to zero</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_ta_freq</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_detuning</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">ramp_repump_freq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_TA_VCO_RAMP_TIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;img_ta_power should not be zero&quot;</span>
        <span class="k">assert</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;img_repump_power should not be zero&quot;</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="TweezerSequence.load_tweezers">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence.load_tweezers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_tweezers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load atoms into optical tweezers.</span>

<span class="sd">        Executes a complete sequence to load atoms from MOT into optical tweezers:</span>
<span class="sd">        1. Load MOT and cool to molasses</span>
<span class="sd">        2. Ramp up tweezer power</span>
<span class="sd">        3. Optional parity projection pulse</span>
<span class="sd">        4. Configure imaging parameters</span>
<span class="sd">        5. Optional robust loading pulse for additional cooling</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the loading sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the loading sequence</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If time-of-flight delay is too short</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO: does making this delay longer make the background better when using UV?</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">7e-3</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">TweezerLaser</span><span class="o">.</span><span class="n">CONST_TWEEZER_RAMPING_TIME</span><span class="p">,</span> <span class="n">final_power</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1"># ramp to full power and parity projection</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_parity_projection_pulse</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">parity_projection_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_pulse_dur</span>
            <span class="p">)</span>
            <span class="c1"># if doing parity projection, synchronize with power ramp</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t_aom_start</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_parity_projection_pulse_dur</span>

        <span class="c1"># t = self.do_molasses(t, dur=shot_globals.bm_time, close_all_shutters=True)</span>
        <span class="c1"># t += shot_globals.bm_time</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ramp_to_imaging_parameters</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_robust_loading_pulse</span><span class="p">:</span>
            <span class="c1"># additional cooling, previously referred to as &quot;robust_loading&quot;</span>
            <span class="c1"># sometimes don&#39;t use this when tweezer debugging is needed?</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_robust_loading_pulse_dur</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">IMG_FULL</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span> <span class="o">&gt;</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_MIN_SHUTTER_OFF_TIME</span>
        <span class="p">),</span> <span class="s2">&quot;time of flight needs to be greater than CONST_MIN_SHUTTER_OFF_TIME&quot;</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_tof_imaging_delay</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="TweezerSequence.tweezer_modulation">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence.tweezer_modulation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tweezer_modulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sine&quot;</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="TweezerSequence.rearrange_to_dense">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence.rearrange_to_dense">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rearrange_to_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rearrange atoms into a dense configuration.</span>

<span class="sd">        Not yet implemented. Will provide functionality to rearrange atoms</span>
<span class="sd">        in tweezers to form dense arrays or specific patterns.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for rearrangement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="TweezerSequence.image_tweezers">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence.image_tweezers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">image_tweezers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Image atoms in optical tweezers.</span>

<span class="sd">        Captures images of atoms in tweezers with proper timing for different shots.</span>
<span class="sd">        Handles both first and second imaging shots with appropriate delays for</span>
<span class="sd">        camera readout and shutter operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for imaging</span>
<span class="sd">            shot_number (int): Which shot in the imaging sequence (1 or 2)</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the imaging sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ramp_to_imaging_parameters</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_tweezer_imaging</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">do_shutter_close_after_first_shot</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># pulse for the second shots and wait for the first shot to finish the</span>
            <span class="c1"># first reading</span>
            <span class="c1"># print(shot_globals.kinetix_roi_row)</span>
            <span class="n">kinetix_readout_time</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">kinetix_roi_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">4.7065e-6</span>
            <span class="c1"># need extra 7 ms for shutter to close on the second shot</span>
            <span class="c1"># TODO: is shot_globals.kinetix_extra_readout_time always zero? Delete if so.</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">kinetix_readout_time</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">kinetix_extra_readout_time</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_tweezer_imaging</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="TweezerSequence.do_tweezer_imaging">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence.do_tweezer_imaging">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_tweezer_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the tweezer imaging sequence.</span>

<span class="sd">        Configures and executes the imaging sequence for atoms in tweezers:</span>
<span class="sd">        1. Set up imaging shutters and laser pulses</span>
<span class="sd">        2. Configure camera parameters</span>
<span class="sd">        3. Synchronize camera exposure with laser pulses</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for imaging</span>
<span class="sd">            close_all_shutters (bool, optional): Whether to close all shutters after</span>
<span class="sd">                imaging. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the imaging sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shutter_config</span> <span class="o">=</span> <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">select_imaging_shutters</span><span class="p">(</span><span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_pulse_end</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span>
            <span class="n">shutter_config</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_ta_power</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_repump_power</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="n">close_all_shutters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="s2">&quot;kinetix&quot;</span><span class="p">)</span>
        <span class="n">exposure_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">img_exposure_time</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>

        <span class="c1"># expose the camera</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Camera_obj</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">t_aom_start</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">)</span>

        <span class="c1"># Closes the aom and the specified shutters</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">exposure_time</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_pulse_end</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="TweezerSequence.pump_then_rotate">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.TweezerSequence.pump_then_rotate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pump_then_rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">B_field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pumps to stretched state then rotates the field</span>
<span class="sd">        Also lowers the trap, but doesn&#39;t raise it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time (modulo shutter handling)</span>
<span class="sd">            B_field (tuple): Final B field. Must be in cartesian form</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Making sure the ramp ends right as the pumping is starting</span>
        <span class="n">t_start_ramp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">t_aom_off</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>
        <span class="p">)</span>

        <span class="c1"># ramp down the tweezer power before optical pumping</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t_start_ramp</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="c1"># extra time to wait for 5e-3s extra time in optical pumping field</span>
            <span class="n">bias_field_vector</span><span class="o">=</span><span class="n">B_field</span><span class="p">,</span>
            <span class="c1"># dur=shot_globals.mw_bias_ramp_dur,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_do_tweezer_check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a basic tweezer loading and imaging check sequence.</span>

<span class="sd">        Executes a complete sequence to verify tweezer operation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Wait specified time</span>
<span class="sd">        4. Take second image</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># TODO: add tweezer modulation here, or in a separate sequence?</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># t = self.TweezerLaser_obj.stop_tweezers(t)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_tweezer_position_check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a basic tweezer loading and imaging check sequence.</span>

<span class="sd">        Executes a complete sequence to verify tweezer operation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Wait specified time</span>
<span class="sd">        4. Take second image</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">aom_on</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_power</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tweezer_release_recapture_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a release and recapture sequence.</span>

<span class="sd">        Not yet implemented. Will provide functionality to release atoms</span>
<span class="sd">        from tweezers and recapture them after a specified time.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tweezer_modulation_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a tweezer modulation sequence.</span>

<span class="sd">        Not yet implemented. Will provide functionality to perform</span>
<span class="sd">        a complete sequence involving tweezer modulation.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_optical_pump_mot_in_tweezer_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check optical pumping using mot beams for atoms in tweezers.</span>

<span class="sd">        Performs a comprehensive sequence to verify optical pumping in tweezers:</span>
<span class="sd">        1. Load atoms and take initial image</span>
<span class="sd">        2. Optional depumping before main pumping</span>
<span class="sd">        3. Perform main optical pumping (to F=4) or depumping (to F=3)</span>
<span class="sd">        4. Optional post-pump operations (depumping or microwave)</span>
<span class="sd">        5. Configure magnetic fields for state manipulation</span>

<span class="sd">        The sequence can be configured through shot_globals parameters for</span>
<span class="sd">        various pumping and manipulation options.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-3</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_depump_ta_pulse_before_pump</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_ta_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_op</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dp</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_to_F3</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_depump_ta_pulse_after_pump</span><span class="p">:</span>
            <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_ta_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># [mw_biasx_field, mw_biasy_field, mw_biasz_field] = [</span>
            <span class="c1">#     shot_globals.mw_biasx_field,</span>
            <span class="c1">#     shot_globals.mw_biasy_field,</span>
            <span class="c1">#     shot_globals.mw_biasz_field,</span>
            <span class="c1"># ]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
                <span class="n">t_aom_off</span><span class="p">,</span>
                <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span><span class="p">),</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_ramp_dur</span><span class="p">,</span>
            <span class="p">)</span>


        <span class="c1"># This is trying to make sure when the ramp of tweezer end (it reaches the minimum power), the shutter config is already switched to optical pumping</span>
        <span class="c1"># if the tweezer ramp is too quick, it will wait extra time at high power before the shutter switching finishes</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_MIN_SHUTTER_ON_TIME</span>
            <span class="o">+</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_SHUTTER_TURN_ON_TIME</span>
            <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>


        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_field_wait_dur</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
            <span class="c1"># self.TweezerLaser_obj.aom_off(t)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>
            <span class="c1"># self.TweezerLaser_obj.aom_on(t, shot_globals.tw_ramp_power)</span>
        <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
            <span class="n">mw_sweep_start</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">mw_sweep_end</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_sweep</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">mw_sweep_start</span><span class="p">,</span> <span class="n">mw_sweep_end</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_duration</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="c1"># If we use the MOT beams for pumping we have to switch shutters</span>
            <span class="c1"># Our pulse function is set so that switching the shutters adds time before the pulse</span>
            <span class="c1"># Here though we want the shutter switching to overlap with the tweezer ramp rather than start after it</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">D2Lasers</span><span class="o">.</span><span class="n">CONST_SHUTTER_TURN_ON_TIME</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>  <span class="c1"># TODO: from the photodetector, the optical pumping beam shutter seems to be closing slower than others</span>
        <span class="c1"># that&#39;s why we add extra time here before imaging to prevent light leakage from optical pump beam</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_optical_pump_sigma_in_tweezer_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check optical pumping using sigma+ beam for atoms in tweezers.</span>

<span class="sd">        Performs a comprehensive sequence to verify optical pumping in tweezers:</span>
<span class="sd">        1. Load atoms and take initial image</span>
<span class="sd">        2. Optional depumping before main pumping</span>
<span class="sd">        3. Perform main optical pumping (to F=4) or depumping (to F=3)</span>
<span class="sd">        4. Optional post-pump operations (depumping or microwave)</span>
<span class="sd">        5. Configure magnetic fields for state manipulation</span>

<span class="sd">        The sequence can be configured through shot_globals parameters for</span>
<span class="sd">        various pumping and manipulation options.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-3</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_depump_ta_pulse_before_pump</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_ta_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_op</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mf">5e-3</span>

        <span class="c1"># Making sure the ramp ends right as the pumping is starting</span>
        <span class="n">t_start_ramp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">t_aom_off</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>
        <span class="p">)</span>

        <span class="c1"># ramp down the tweezer power before optical pumping</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t_start_ramp</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span>

        <span class="c1"># ramp up the tweezer power after optical pumping</span>
        <span class="c1"># _ = self.TweezerLaser_obj.ramp_power(</span>
        <span class="c1">#     t_aom_off, shot_globals.tw_ramp_dur, 0.99</span>
        <span class="c1"># )</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_depump_ta_pulse_after_pump</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_ta_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># [mw_biasx_field, mw_biasy_field, mw_biasz_field] = [</span>
        <span class="c1">#     shot_globals.mw_biasx_field,</span>
        <span class="c1">#     shot_globals.mw_biasy_field,</span>
        <span class="c1">#     shot_globals.mw_biasz_field,</span>
        <span class="c1"># ]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="c1"># extra time to wait for 5e-3s extra time in optical pumping field</span>
            <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span><span class="p">),</span>
            <span class="c1"># dur=shot_globals.mw_bias_ramp_dur,</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_field_wait_dur</span>  <span class="c1"># 400e-6</span>
        <span class="c1"># t = self.TweezerLaser_obj.ramp_power(</span>
        <span class="c1">#     t, shot_globals.tw_ramp_dur, shot_globals.tw_ramp_power</span>
        <span class="c1"># )</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
            <span class="c1"># self.TweezerLaser_obj.aom_off(t)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">)</span>
            <span class="c1"># self.TweezerLaser_obj.aom_on(t, shot_globals.tw_ramp_power)</span>
        <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span><span class="p">:</span>
            <span class="n">mw_sweep_start</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">mw_sweep_end</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_detuning</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_range</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_sweep</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">mw_sweep_start</span><span class="p">,</span> <span class="n">mw_sweep_end</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_sweep_duration</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="c1"># t, _ = self.kill_F4(</span>
            <span class="c1">#     t - D2Lasers.CONST_SHUTTER_TURN_ON_TIME, close_all_shutters=False</span>
            <span class="c1"># )</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>  <span class="c1"># TODO: from the photodetector, the optical pumping beam shutter seems to be closing slower than others</span>
        <span class="c1"># that&#39;s why we add extra time here before imaging to prevent light leakage from optical pump beam</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_dark_state_lifetime_in_tweezer_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check optical pumping using sigma+ beam for atoms in tweezers.</span>

<span class="sd">        Performs a comprehensive sequence to verify optical pumping in tweezers:</span>
<span class="sd">        1. Load atoms and take initial image</span>
<span class="sd">        3. Perform main optical pumping (to F=4) or depumping (to F=3)</span>
<span class="sd">        4. depumping TA pulse to measure dark state decay back to F=3</span>
<span class="sd">        5. Optional: killing pulse (remove F=4 atoms) to do state dependent measurement</span>

<span class="sd">        The sequence can be configured through shot_globals parameters for</span>
<span class="sd">        various pumping and manipulation options.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-3</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">5e-3</span>

        <span class="c1"># Making sure the ramp ends right as the pumping is starting</span>
        <span class="n">t_start_ramp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">t_aom_off</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>
        <span class="p">)</span>

        <span class="c1"># ramp down the tweezer power before optical pumping</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t_start_ramp</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span>

        <span class="c1"># ramp up the tweezer power after optical pumping</span>
        <span class="c1"># _ = self.TweezerLaser_obj.ramp_power(</span>
        <span class="c1">#     t_aom_off, shot_globals.tw_ramp_dur, 0.99</span>
        <span class="c1"># )</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depump_ta_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># t = self.BField_obj.ramp_bias_field(t, bias_field_vector=(0, 0, 0))</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span>


        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># t, _ = self.kill_F4(</span>
            <span class="c1">#     t - D2Lasers.CONST_SHUTTER_TURN_ON_TIME, close_all_shutters=False</span>
            <span class="c1"># )</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>  <span class="c1"># TODO: from the photodetector, the optical pumping beam shutter seems to be closing slower than others</span>
        <span class="c1"># that&#39;s why we add extra time here before imaging to prevent light leakage from optical pump beam</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="RydSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.RydSequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RydSequence</span><span class="p">(</span><span class="n">TweezerSequence</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RydSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span> <span class="o">=</span> <span class="n">RydLasers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<div class="viewcode-block" id="RydSequence.pulsed_rydberg_excitation">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.RydSequence.pulsed_rydberg_excitation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pulsed_rydberg_excitation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n_pulses</span><span class="p">,</span> <span class="n">pulse_dur</span><span class="p">,</span> <span class="n">pulse_wait_dur</span><span class="p">,</span> <span class="n">power_456</span><span class="p">,</span> <span class="n">power_1064</span><span class="p">,</span> <span class="n">just_456</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># print(&#39;multipulse start time t = &#39;, t)</span>

        <span class="c1"># t, pulse_times = self.RydLasers_obj.do_rydberg_multipulses(</span>
        <span class="c1">#     t, n_pulses, pulse_dur, pulse_wait_dur,</span>
        <span class="c1">#     power_456, power_1064,</span>
        <span class="c1">#     just_456=just_456, close_shutter=close_shutter</span>
        <span class="c1">#     )</span>

        <span class="c1"># print(&#39;multipulse end time t = &#39;,t)</span>

        <span class="c1"># offset tweezer pulse times to match Rydberg pulse times; empirically determined workaround</span>
        <span class="c1"># pulse_times_anticipated = np.asarray(pulse_times) - 0.3e-6</span>
        <span class="c1"># for pulse_time in pulse_times_anticipated:</span>
        <span class="c1">#     self.TweezerLaser_obj.aom_off(pulse_time, digital_only=True)</span>
        <span class="c1">#     self.TweezerLaser_obj.aom_on(pulse_time + pulse_dur, 0.99, digital_only=True)</span>

        <span class="c1"># turn off tweezer laser during the Rydberg pulse.</span>
        <span class="c1"># Make sure tweezers are indeed turned off when taking thermalization into account. This means we turn tweezer off for longer than the pulse time</span>
        <span class="c1"># For a single pulse</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">pulse_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_rydberg_pulse_short</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_pulse_dur</span><span class="p">,</span>
            <span class="n">power_456</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
            <span class="n">power_1064</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_1064_power</span><span class="p">,</span>
            <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">tweezer_switch_buffer</span> <span class="o">=</span> <span class="mf">2e-6</span>
        <span class="n">pulse_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pulse_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">tweezer_switch_buffer</span><span class="p">,</span> <span class="n">pulse_times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tweezer_switch_buffer</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.3e-6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">aom_off</span><span class="p">(</span><span class="n">pulse_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">digital_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">aom_on</span><span class="p">(</span><span class="n">pulse_times</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span><span class="p">,</span> <span class="n">digital_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_do_dipole_trap_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">pulse_1064_aom_on</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">pulse_1064_aom_off</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">aom_off</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">bm_time</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-3</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_blue_kill</span><span class="p">:</span>
            <span class="c1">#Apply repump pulse</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
                <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_REPUMP</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_repump_power</span><span class="p">,</span>
                <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_456_pulse</span><span class="p">(</span>
                <span class="n">t_aom_start</span><span class="p">,</span> <span class="c1"># synchronize with repump pulse</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
                <span class="n">power_456</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
                <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Close shutter after pulse to prevent any residual light</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_ryd_2_photon</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_456_pulse</span><span class="p">(</span>
                <span class="n">t_aom_start</span><span class="p">,</span> <span class="c1"># synchronize with repump pulse</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
                <span class="n">power_456</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
                <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Close shutter after pulse to prevent any residual light</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_tof_imaging_delay</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">ta_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_ta_power</span><span class="p">,</span>
            <span class="n">ta_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_ta_detuning</span><span class="p">,</span>
            <span class="n">repump_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_repump_power</span><span class="p">,</span>
            <span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_exposure_time</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># self.RydLasers_obj.pulse_1064_aom_off(t)</span>

        <span class="n">t</span><span class="o">+=</span> <span class="mf">1e-1</span>
        <span class="c1"># Background image</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_molasses_dipole_trap_imaging</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">ta_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_ta_power</span><span class="p">,</span>
            <span class="n">ta_detuning</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_ta_detuning</span><span class="p">,</span>
            <span class="n">repump_power</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_repump_power</span><span class="p">,</span>
            <span class="n">do_repump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">exposure_time</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">dp_img_exposure_time</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_ryd_check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Rydberg excitation check sequence.</span>

<span class="sd">        Executes a sequence to verify Rydberg excitation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Apply Rydberg excitation pulse</span>
<span class="sd">        4. Take second image to check for atom loss</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-3</span>

        <span class="n">B_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_then_rotate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">B_field</span><span class="p">)</span> <span class="c1"># trap is lowered when optical pump happens</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span> <span class="c1"># ramp trap power back</span>
        <span class="c1"># Apply Rydberg pulse with both 456 and 1064 active</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_rydberg_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
            <span class="n">power_456</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
            <span class="n">power_1064</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_1064_power</span><span class="p">,</span>
            <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Close shutter after pulse to prevent any residual light</span>
        <span class="p">)</span>

        <span class="c1"># t = self.TweezerLaser_obj.ramp_power(t, shot_globals.tw_ramp_dur, 0.99)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>  <span class="c1"># TODO: from the photodetector, the optical pumping beam shutter seems to be closing slower than others</span>
        <span class="c1"># that&#39;s why we add extra time here before imaging to prevent light leakage from optical pump beam</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_ryd_check_trap_off_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Rydberg excitation check sequence.</span>

<span class="sd">        Executes a sequence to verify Rydberg excitation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Apply Rydberg excitation pulse</span>
<span class="sd">        4. Take second image to check for atom loss</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-3</span>

        <span class="n">B_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_then_rotate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">B_field</span><span class="p">)</span> <span class="c1"># trap is lowered when optical pump happens</span>
        <span class="c1"># self.TweezerLaser_obj.ramp_power(t, shot_globals.tw_ramp_dur, 0.99)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">100e-6</span>
        <span class="c1"># Apply Rydberg pulse with both 456 and 1064 active</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">pulse_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_rydberg_pulse_short</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_pulse_dur</span><span class="p">,</span>
            <span class="n">power_456</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
            <span class="n">power_1064</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_1064_power</span><span class="p">,</span>
            <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># turn off tweezer laser during the Rydberg pulse</span>
        <span class="n">tweezer_switch_buffer</span> <span class="o">=</span> <span class="mf">2e-6</span>
        <span class="n">pulse_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pulse_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">tweezer_switch_buffer</span><span class="p">,</span> <span class="n">pulse_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tweezer_switch_buffer</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.3e-6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">aom_off</span><span class="p">(</span><span class="n">pulse_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">digital_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">aom_on</span><span class="p">(</span><span class="n">pulse_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span><span class="p">,</span> <span class="n">digital_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">pulse_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

        <span class="c1"># t = self.TweezerLaser_obj.ramp_power(t, shot_globals.tw_ramp_dur, 0.99)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>  <span class="c1"># TODO: from the photodetector, the optical pumping beam shutter seems to be closing slower than others</span>
        <span class="c1"># that&#39;s why we add extra time here before imaging to prevent light leakage from optical pump beam</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_ryd_multipulse_check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Rydberg pulse excitation check sequence.</span>

<span class="sd">        Executes a sequence to verify Rydberg excitation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Apply Rydberg excitation multipulses</span>
<span class="sd">        4. Take second image to check for atom loss</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">1e-3</span>

        <span class="n">B_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_then_rotate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">B_field</span><span class="p">)</span> <span class="c1"># trap is lowered when optical pump happens</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span> <span class="c1"># ramp trap power back</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">100e-6</span>
        <span class="c1"># Apply Rydberg pulse with both 456 and 1064 active</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulsed_rydberg_excitation</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">n_pulses</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_n_pulses</span><span class="p">,</span>
            <span class="n">pulse_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_pulse_dur</span><span class="p">,</span> <span class="n">pulse_wait_dur</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_pulse_wait_dur</span><span class="p">,</span>
            <span class="n">power_456</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span> <span class="n">power_1064</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_1064_power</span><span class="p">,</span>
            <span class="n">just_456</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># t = self.TweezerLaser_obj.ramp_power(t, shot_globals.tw_ramp_dur, 0.99)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">2e-3</span>  <span class="c1"># TODO: from the photodetector, the optical pumping beam shutter seems to be closing slower than others</span>
        <span class="c1"># that&#39;s why we add extra time here before imaging to prevent light leakage from optical pump beam</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_456_check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Rydberg excitation check sequence.</span>

<span class="sd">        Executes a sequence to verify Rydberg excitation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Apply Rydberg excitation pulse</span>
<span class="sd">        4. Take second image to check for atom loss</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Apply repump pulse</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
            <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_REPUMP</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_repump_power</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Apply Rydberg pulse with only 456 active</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_rydberg_pulse</span><span class="p">(</span>
            <span class="n">t_aom_start</span><span class="p">,</span> <span class="c1"># synchronize with repump pulse</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
            <span class="n">power_456</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
            <span class="n">power_1064</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Close shutter after pulse to prevent any residual light</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_456_check_with_dark_state_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Rydberg excitation check sequence.</span>

<span class="sd">        Executes a sequence to verify Rydberg excitation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Optical pumping to strechted state</span>
<span class="sd">        4. rotate the field to align with the ryberg beam axis</span>
<span class="sd">        5. Apply Rydberg excitation pulse</span>
<span class="sd">        6. Take second image to check for atom loss</span>
<span class="sd">        7. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-3</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">5e-3</span>

        <span class="c1"># Making sure the ramp ends right as the pumping is starting</span>
        <span class="n">t_start_ramp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">t_aom_off</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>
        <span class="p">)</span>

        <span class="c1"># ramp down the tweezer power before optical pumping</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t_start_ramp</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span> <span class="c1"># this should not return t because then it would make the next step (field rampping) happens too early</span>


        <span class="n">ryd_biasx_field</span><span class="p">,</span> <span class="n">ryd_biasy_field</span><span class="p">,</span> <span class="n">ryd_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="c1"># extra time to wait for 5e-3s extra time in optical pumping field</span>
            <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">ryd_biasx_field</span><span class="p">,</span> <span class="n">ryd_biasy_field</span><span class="p">,</span> <span class="n">ryd_biasz_field</span><span class="p">),</span>
            <span class="c1"># dur=shot_globals.mw_bias_ramp_dur,</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="c1"># Apply repump pulse</span>
        <span class="c1"># t, t_aom_start = self.D2Lasers_obj.do_pulse(</span>
        <span class="c1">#     t,</span>
        <span class="c1">#     shot_globals.ryd_456_duration,</span>
        <span class="c1">#     ShutterConfig.OPTICAL_PUMPING_REPUMP,</span>
        <span class="c1">#     0,</span>
        <span class="c1">#     shot_globals.ryd_456_repump_power,</span>
        <span class="c1">#     close_all_shutters=True,</span>
        <span class="c1"># )</span>
        <span class="c1"># Apply Rydberg pulse with only 456 active</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_rydberg_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="c1">#t_aom_start synchronize with repump pulse</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
            <span class="n">power_456</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
            <span class="n">power_1064</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Close shutter after pulse to prevent any residual light</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># t, _ = self.kill_F4(</span>
            <span class="c1">#     t - D2Lasers.CONST_SHUTTER_TURN_ON_TIME, close_all_shutters=False</span>
            <span class="c1"># )</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_1064_check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Rydberg excitation check sequence.</span>

<span class="sd">        Executes a sequence to verify Rydberg excitation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Apply Rydberg excitation pulse</span>
<span class="sd">        4. Take second image to check for atom loss</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-3</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">5e-3</span>

        <span class="c1"># Making sure the ramp ends right as the pumping is starting</span>
        <span class="n">t_start_ramp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">t_aom_off</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>
        <span class="p">)</span>

        <span class="c1"># ramp down the tweezer power before optical pumping</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t_start_ramp</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span>


        <span class="n">ryd_biasx_field</span><span class="p">,</span> <span class="n">ryd_biasy_field</span><span class="p">,</span> <span class="n">ryd_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="c1"># extra time to wait for 5e-3s extra time in optical pumping field</span>
            <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">ryd_biasx_field</span><span class="p">,</span> <span class="n">ryd_biasy_field</span><span class="p">,</span> <span class="n">ryd_biasz_field</span><span class="p">),</span>
            <span class="c1"># dur=shot_globals.mw_bias_ramp_dur,</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="c1"># Apply repump pulse</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D2Lasers_obj</span><span class="o">.</span><span class="n">do_pulse</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
            <span class="n">ShutterConfig</span><span class="o">.</span><span class="n">OPTICAL_PUMPING_REPUMP</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_repump_power</span><span class="p">,</span>
            <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Apply Rydberg pulse with both 456 and 1064 active</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">do_rydberg_pulse</span><span class="p">(</span>
            <span class="n">t_aom_start</span><span class="p">,</span> <span class="c1">#t, synchronize with repump pulse</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">,</span>
            <span class="n">power_456</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_power</span><span class="p">,</span>
            <span class="n">power_1064</span><span class="o">=</span><span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_1064_power</span><span class="p">,</span>
            <span class="n">close_shutter</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Close shutter after pulse to prevent any residual light</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># t, _ = self.kill_F4(</span>
            <span class="c1">#     t - D2Lasers.CONST_SHUTTER_TURN_ON_TIME, close_all_shutters=False</span>
            <span class="c1"># )</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_1064_light_shift_check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Rydberg excitation check sequence.</span>

<span class="sd">        Executes a sequence to verify Rydberg excitation:</span>
<span class="sd">        1. Load atoms into tweezers</span>
<span class="sd">        2. Take first image</span>
<span class="sd">        3. Apply Rydberg excitation pulse</span>
<span class="sd">        4. Take second image to check for atom loss</span>
<span class="sd">        5. Reset MOT parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): Start time for the sequence</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: End time of the sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">3e-3</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">t_aom_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pump_to_F4</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">5e-3</span>

        <span class="c1"># Making sure the ramp ends right as the pumping is starting</span>
        <span class="n">t_start_ramp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">t_aom_off</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span> <span class="o">-</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_repump_time</span>
        <span class="p">)</span>

        <span class="c1"># ramp down the tweezer power before optical pumping</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span>
            <span class="n">t_start_ramp</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_power</span>
        <span class="p">)</span>


        <span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">convert_bias_fields_sph_to_cart</span><span class="p">(</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_amp</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_phi</span><span class="p">,</span>
                <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_bias_theta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BField_obj</span><span class="o">.</span><span class="n">ramp_bias_field</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="c1"># extra time to wait for 5e-3s extra time in optical pumping field</span>
            <span class="n">bias_field_vector</span><span class="o">=</span><span class="p">(</span><span class="n">mw_biasx_field</span><span class="p">,</span> <span class="n">mw_biasy_field</span><span class="p">,</span> <span class="n">mw_biasz_field</span><span class="p">),</span>
            <span class="c1"># dur=shot_globals.mw_bias_ramp_dur,</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span><span class="p">:</span>
            <span class="c1"># self.TweezerLaser_obj.aom_off(t)</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">t_1st_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">do_ramsey_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">mw_time</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span><span class="p">)</span>

        <span class="c1"># insert a 1064 pulse between two microwave pulse that has the same phase, make sure the pulse start the end of the 1st pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">pulse_1064_aom_on</span><span class="p">(</span><span class="n">t_1st_end</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_1064_power</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t_1st_end</span> <span class="o">+</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">ryd_456_duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RydLasers_obj</span><span class="o">.</span><span class="n">pulse_1064_aom_off</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="mf">10e-3</span>

        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_killing_pulse</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_F4</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">close_all_shutters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># t, _ = self.kill_F4(</span>
            <span class="c1">#     t - D2Lasers.CONST_SHUTTER_TURN_ON_TIME, close_all_shutters=False</span>
            <span class="c1"># )</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_killing_pulse_time</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">ramp_power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">tw_ramp_dur</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">+=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">img_wait_time_between_shots</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span></div>


<span class="c1"># Full Sequences, we&#39;ll see if we really want all these in a class or just separate sequence files?</span>
<div class="viewcode-block" id="ScienceSequence">
<a class="viewcode-back" href="../../api.html#standard_sequence.classy_sequence.ScienceSequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ScienceSequence</span><span class="p">(</span><span class="n">RydSequence</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ScienceSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">labscript</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sequence_objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Insert &quot;stay on&quot; statements for alignment here...</span>

    <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_in_situ_check</span><span class="p">:</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MOTSeq_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">_do_mot_in_situ_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mot_tof_check</span><span class="p">:</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MOTSeq_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">_do_mot_tof_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_in_situ_check</span><span class="p">:</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MOTSeq_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">_do_molasses_in_situ_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_molasses_tof_check</span><span class="p">:</span>
        <span class="n">MOTSeq_obj</span> <span class="o">=</span> <span class="n">MOTSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MOTSeq_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MOTSeq_obj</span><span class="o">.</span><span class="n">_do_molasses_tof_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_pump_debug_in_molasses</span><span class="p">:</span>
        <span class="n">OPSeq_obj</span> <span class="o">=</span> <span class="n">OpticalPumpingSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OPSeq_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">OPSeq_obj</span><span class="o">.</span><span class="n">_do_pump_debug_in_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_F4_microwave_spec_molasses</span><span class="p">:</span>
        <span class="n">OPSeq_obj</span> <span class="o">=</span> <span class="n">OpticalPumpingSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OPSeq_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">OPSeq_obj</span><span class="o">.</span><span class="n">_do_F4_microwave_spec_molasses</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">reset_mot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># if shot_globals.do_dipole_trap_tof_check:</span>
    <span class="c1">#     t = do_dipole_trap_tof_check(t)</span>

    <span class="c1"># if shot_globals.do_img_beam_alignment_check:</span>
    <span class="c1">#     t = do_img_beam_alignment_check(t)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_check</span><span class="p">:</span>
        <span class="n">TweezerSequence_obj</span> <span class="o">=</span> <span class="n">TweezerSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TweezerSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TweezerSequence_obj</span><span class="o">.</span><span class="n">_do_tweezer_check_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_tweezer_position_check</span><span class="p">:</span>
        <span class="n">TweezerSequence_obj</span> <span class="o">=</span> <span class="n">TweezerSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TweezerSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TweezerSequence_obj</span><span class="o">.</span><span class="n">_do_tweezer_position_check_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_ryd_tweezer_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_ryd_check_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_ryd_tweezer_trap_off_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_ryd_check_trap_off_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_ryd_multipulse_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_ryd_multipulse_check_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_456_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_456_check_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dipole_trap_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_dipole_trap_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># if shot_globals.do_tweezer_check_fifo:</span>
    <span class="c1">#     t = do_tweezer_check_fifo(t)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_optical_pump_in_tweezer_check</span><span class="p">:</span>
        <span class="n">TweezerSequence_obj</span> <span class="o">=</span> <span class="n">TweezerSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TweezerSequence_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span> <span class="o">==</span> <span class="s2">&quot;mot&quot;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">TweezerSequence_obj</span><span class="o">.</span><span class="n">_do_optical_pump_mot_in_tweezer_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span> <span class="o">==</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">TweezerSequence_obj</span><span class="o">.</span><span class="n">_do_optical_pump_sigma_in_tweezer_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_dark_state_lifetime_in_tweezer_check</span><span class="p">:</span>
        <span class="n">TweezerSequence_obj</span> <span class="o">=</span> <span class="n">TweezerSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TweezerSequence_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span> <span class="o">==</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">TweezerSequence_obj</span><span class="o">.</span><span class="n">_do_dark_state_lifetime_in_tweezer_check</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_456_with_dark_state_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">op_label</span> <span class="o">==</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_456_check_with_dark_state_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_1064_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_1064_check_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_1064_light_shift_check</span><span class="p">:</span>
        <span class="n">RydSequence_obj</span> <span class="o">=</span> <span class="n">RydSequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sequence_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RydSequence_obj</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RydSequence_obj</span><span class="o">.</span><span class="n">_do_1064_light_shift_check_sequence</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># if shot_globals.do_optical_pump_in_microtrap_check:</span>
    <span class="c1">#     t = do_optical_pump_in_microtrap_check(t)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; Here doing all the finish up quirk for spectrum cards &quot;&quot;&quot;</span>
    <span class="c1"># Find the first non-None sequence object</span>
    <span class="n">current_obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">sequence_objects</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">current_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No valid sequence object found&quot;</span><span class="p">)</span>

    <span class="c1"># Stop tweezers if the object has a TweezerLaser_obj</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current_obj</span><span class="p">,</span> <span class="s1">&#39;TweezerLaser_obj&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;current_obj has TweezerLaser_obj&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">current_obj</span><span class="o">.</span><span class="n">TweezerLaser_obj</span><span class="o">.</span><span class="n">stop_tweezers</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Reset spectrum if the object has Microwave_obj and if we use microwave in the sequence</span>
    <span class="n">do_mw</span> <span class="o">=</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_pulse</span> <span class="ow">or</span> <span class="n">shot_globals</span><span class="o">.</span><span class="n">do_mw_sweep</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">sequence_objects</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;Microwave_obj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">do_mw</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">Microwave_obj</span><span class="o">.</span><span class="n">reset_spectrum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">labscript</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Michelle Wu, Lin Xin, Nolan Peard, Sam Cohen, Tony Zhang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>